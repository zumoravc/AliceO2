<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: DetectorSimulation.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d4/d6b/DetectorSimulation_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">DetectorSimulation.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d4/d6b/DetectorSimulation_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;!-- doxy</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\page refdocDetectorSimulation Detector Simulation</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/doxy --&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;# Detector simulation documentation</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;The present document collects information about the ALICE detector simulation executable and digitization procedure used in LHC Run3.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;## Overview</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;Detector simulation, the simulation of detector response from virtual particle events, consists of essentialy 2 parts:</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;  a) the generation of simple (energy deposit) traces in the detector due to the passage of particles and the interaction with the detector material.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;  b) the conversion of those traces into (electronic) signals in the detector readout (usually called digitization).</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160; </div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;The first part is handled by the `o2-sim` executable (See [SimSection](#SimSection)). The second part is handled in the `o2-sim-digitizer-workflow` executable (See [DigitSection](#DigitSection)). References to examples are [collected here](#Examples).</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;## Key new features with respect to AliRoot</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;The Run3 simulation offers the following features</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;  - **distributed system based on FairMQ** that is splitting event generation, particle transport and IO into separate asyncronous components that can be deployed on different machines</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;  - **sub-event parallelism** making it possible to transport a single big event in a short time and to reduce memory consumption</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;  - **parallelism** independent on transport engine</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;  - **configuration via pre-defined parameter classes and ini/text files**</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;  - **clear separation of transport and digitization** - each phase can be run fully independently</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;# Documentation of transport simulation &lt;a name=&quot;SimSection&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;The purpose of the `o2-sim` executable is to simulate the passage of particles emerging from a collision inside the detector and to obtain their effect in terms of energy deposits (called hits) which could be converted into detectable signals. It is the driver executable which will spawn a topology of sub-processes that interact via messages in a distributed system.</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;## Usage overview</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;* **Quick start example:** A typical (exemplary) invocation is of the form </div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;    ```o2-sim -n 10 -g pythia8 -e TGeant4 -j 2 --skipModules ZDC,PHS``` </div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;    which would launch a simulation for 10 pythia8 events on the whole ALICE detector but ZDC and PHOS, using Geant4 on 2 parallel worker processes.</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;* **Generated output**: The simulation creates the following output files:</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;     </div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;| File                  | Description                                                                            |</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;| --------------------- | -------------------------------------------------------------------------------------- |</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;| `o2sim_Kine.root`     | contains kinematics information (primaries and secondaries) and event meta information |</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;| `o2sim_geometry.root` | contains the final ROOT geometry created for simulation run                            |</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;| `o2sim_grp.root`      | special global run parameters (grp) such as field                                      |</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;| `o2sim_XXXHits.root`  | hit file for each participating active detector XXX                                    |</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;| `o2sim_configuration.ini` | summary of parameter values with which the simulation was done                     |</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;| `serverlog` | log file produced from the particle generator server |</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;| `workerlog` | log file produced form the transportation processes |</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;| `hitmergerlog` | log file produced from the IO process |</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;* **Main command line options**: The following major options are available (incomplete):</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;| Option                | Description                                                                            |</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;| --------------------- | -------------------------------------------------------------------------------------- |</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;| -h,--help     | Prints the list of possible command line options and their default values.           |</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;| -n,--number | The number of events to simulate.                                                       |</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;| -g,--generator | name of a predefined generator template to use (such as pythia8, pythia8hi). Configuration of generations is explained in a dedicated section. |</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;| -e,--engine | Select the VMC transport engine (TGeant4, TGeant3).                                     |</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;| -m,--modules | List of modules/geometries to include (default is ALL); example -m PIPE ITS TPC       |</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;| -j,--nworkers | Number of parallel simulation engine workers (default is half the number of hyperthread CPU cores) |</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;| --chunkSize | Size of a sub-event. This determines how many primary tracks will be sent to a simulation worker to process. |</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;| --skipModules | List of modules to skip / not to include (precedence over -m) |</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;| --configFile   | A `.ini` file containing a list of (non-default) parameters to configure the simulation run. See section on configurable parameters for more details.  |</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;| --configKeyValues | Like `--configFile` but allowing to set parameters on the command line as a string sequence. Example `--configKeyValues &quot;Stack.pruneKine=false&quot;`. Takes precedence over `--configFile`. Parameters need to be known ConfigurableParams. |</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;| --seed   | The initial seed to (all) random number instances. Default is -1 which leads to random behaviour. |</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;| -o,--outPrefix | How output files should be prefixed. Default is o2sim. Example `-o mySignalProduction`.|</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;* **Expert control** via environment variables:</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;`o2-sim` is sensitive to the following environment variables:</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;| Variable | Description |</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;| --- | --- |</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;| **ALICE_O2SIM_DUMPLOG** | When set, the output of all FairMQ components will be shown on the screen and can be piped into a user logfile. |  </div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;| **ALICE_NOSIMSHM** | When set, communication between simulation processes will not happen using a shared memory mechanism but using ROOT serialization. |</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;## Configurable Parameters</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;Simulation makes use of `configurable parameters` as described in the [ConfigurableParam.md](https://github.com/AliceO2Group/AliceO2/blob/dev/Common/SimConfig/doc/ConfigurableParam.md) documentation.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;Detector code as well as general simulation code declare such parameter and access them during runtime. </div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;Once a parameter is declared, it can be influenced/set from the outside via configuration files or from the command line. See the `--configFile` as well as `--configKeyValues` command line options.</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;The complete list of parameters and their default values can be inspected in the file `o2sim_configuration.ini` that is produced by an empty run `o2-sim -n 0 -m CAVE`.</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;Important parameters influencing the transport simulation are:</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;| Main parameter key | Description |</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;| --- | --- |</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;| G4 | Parameters influencing the Geant4 engine, such as the physics list. Example &quot;G4.physicslist=kFTFP_BERT_optical_biasing&quot; |</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;| Stack | Parameters influencing the particle stack. Example include whether the stack does kinematics pruning or whether it keeps secondaries at all. |</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;| SimCutParams | Parameters allowing to set some sime geometry stepping cuts in R, Z, etc. |</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;| Diamond | Parameter allowing to set the interaction vertex location and the spread/width. Is used in all event generators. |</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;| Pythia6 | Parameters that influence the pythia6 generator. |</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;| Pythia8 | Parameters that influence the pythia8 generator. |</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;| TriggerParticle | Parameters influencing the trigger mechanism in particle generators. |</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;Detectors may also have parameters influencing various pieces such geometry layout, material composition etc.</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;## Help on available generators</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;Below some notes on example generators along with some usage info.</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;* **Fwmugen**</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;fwmugen is a lightweight and simple “box” generator for forward muons (1 muon / event)</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;```</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;o2-sim -m MFT -e TGeant3 -g fwmugen -n 10</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;```</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;* **BoxGen**</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;```</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;o2-sim -m PIPE ITS MFT -e TGeant3 -g boxgen -n 10 --configKeyValues &#39;BoxGun.pdg=13 ; BoxGun.eta[0]=-3.6 ; BoxGun.eta[1]=-2.45; BoxGun.number=100&#39;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;```</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;* **PYTHIA 8**</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;Configures pythia8 for min.bias pp collisions at 14 TeV</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;```</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;o2-sim -m PIPE ITS MFT -g pythia8 -n 50</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;```</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;[Describe in detail the environment variables]</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;## Data layout</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;[Add something on data layout of hits file]</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;## F.A.Q.</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;You may contribute to the documentation by asking a question</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;#### 1. **How can I interface an event generator from ALIROOT**?</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;In order to access event generators from ALIROOT, such as `THijing` or `TPyhtia6`, you may use the `-g extgen` command line option followed by a ROOT macro setting up the event </div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;generator. Examples thereof are available in the installation directory `$O2_ROOT/share/Generators/external`.</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;For example, in order to simulate with 10 Pythia6 events, the following command can be run:</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;```</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;o2-sim -n 10 -g extgen --extGenFile $O2_ROOT/share/Generators/external/pythia6.C</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;```</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;Macro arguments can be passed via</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;`--extGenFunc pythia6(14000., &quot;pythia.settings&quot;)`.</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;Users may write there own macros in order to customize to their needs.</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;#### 2. **How can I run on a subset of geometry modules**?</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;Use the `--modules` or `-m` command line option. Example: `o2-sim -m PIPE ITS TPC`</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;will run the simulation on a geometry/material consinsting of PIPE, ITS, TPC.</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;#### 3. **How can I run with exactly the same events as used in an AliRoot simulation?**</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;One may perform any arbitrary simulation with AliRoot and reuse the kinematics information in form of `Kinemtatics.root`</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;produced. The file contains primary and possibly secondary particles (added by transportation). </div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;When the file is passed to `o2sim`, the primary particles my be used as the initial event. </div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;Use the **`-g extkin`** command line option:</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;```</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;o2-sim -g extkin --extKinFile Kinematics.root ...</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;```</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;#### 4. **How can I generate events (signal) using the vertex position of already-generated (background) events?**</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;This process might be called embedding, where one wants to merge two events generated independenly. For that to be physically correct, both events have to originate from the same interaction vertex.</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;Assuming that your already-generated (background) events are stored in the `o2sim.background.root` file, you can force the interaction vertex for the generation of a new set of events to be the same as the one in the background with the following command line option:</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;```</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;o2-sim --embedIntoFile o2sim.background.root</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;```</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;Background events are sampled one-by-one until all events have been used. At that point the events start to be reused.</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;#### 5. **How can I obtain detailed stepping information?**</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;Run the simulation (currently only supported in combination with `o2-sim-serial`) with a preloaded library:</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;```</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;MCSTEPLOG_TTREE=1 LD_PRELOAD=$O2_ROOT/lib/libMCStepLogger.so o2-sim-serial -j 1 -n 10</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;```</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;This will produce a file `MCStepLoggerOutput.root` containing detailed information about steps and processes (where, what, ...). The file can be analysed using a special analysis framework. See https://github.com/AliceO2Group/AliceO2/blob/dev/Utilities/MCStepLogger/README.md for more documentation.</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;#### 6. **How can I add a trigger to the event generator?**</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;All event generator interfaces that comply with the `o2::eventgen::Generator` protocol can be triggered.</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;A basic &#39;particle trigger&#39; is implemented in the `o2::eventgen` core and allows the user to define a trigger particle.</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;The definitions of the trigger particle can be expressed via command line arguments</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;```</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;o2-sim -g pythia8 -t particle --configKeyValues &quot;TriggerParticle.pdg=333;TriggerParticle.ptMin=5.;TriggerParticle.yMin=-0.5;TriggerParticle.yMax=0.5&quot;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;```</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;Custom triggers can also be constructed by the user to provide unlimited flexibility in the trigger needs.</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;An external trigger function can be specified via command line arguments</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;```</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;o2-sim -g pythia8 -t external --extTrgFile path_to_trigger_macro.C --extTrgFunc &quot;the_function(some, parameters)&quot;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;```</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;The function must comply with a simple protocol and return a lambda function defined as follows</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;```</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;o2::eventgen::Trigger the_function()</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;{</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;  return [](const std::vector&lt;TParticle&gt;&amp; particles) -&gt; bool {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;    return true; // triggered</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;  }</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;}</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;```</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;Within the lambda function the user receives the stack of generated particles and can inspect it to define a trigger at will.</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;The trigger is fired when the lambda function returns `true` and the simulation of the current event is subsequently started.</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;To allow users to define triggers that go beyond the particle stack generated by the event generator, another functionality is added.</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;This allows the user to go deep into the core of the event generator, whenever this is possible.</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;For this reason, this is called a &#39;DeepTrigger&#39;. A &#39;DeepTrigger&#39; is attached to the simulation in the same way as a normal trigger</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;```</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;o2-sim -g pythia8 -t external --extTrgFile path_to_deep_trigger_macro.C --extTrgFunc &quot;the_deep_function(some, parameters)&quot;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;```</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;In this case the function must comply with a similar, but different protocol than before and return a lambda function defined as follows</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;``` o2::eventgen::DeepTrigger the_deep_function()</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;{</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;  return [mpiMin](void* interface, std::string name) -&gt; bool {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;    return true;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;  };</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;}</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;```</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;Notice that in this case the user is presented with a pointer to the event-generator interface and a string that defines its name.</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;For the sake of generality, a `void*` has to be used in order to pass any possible types of event-generators, that are</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;normally othogonal one to another. The name encodes a string to identify what generator has been passed and perform the correct cast to use it.</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;### Deep triggers</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;Deep triggers is just a name to a new functionality that allows the user to define custom functions that will have a direct handle on the event generator interface. The functionality follows the schema of the previous point, with the user providing a custom lambda function that will receive from the framework a pointer to the internal event-generator interface object (i.e. for Pythia8, a pointer to the Pythia object) and a tagname to identify the interface. This functionality might be useful to users who want to provide triggers based on information beyond the stack of the generated particles, based on more internal counters/information in the event generator machinery.</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;Here is an example of a deep trigger implementation in Pythia8.</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;```</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;//   usage: o2sim --trigger external --extTrgFile trigger_mpi.C</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;// options:                          --extTrgFunc &quot;trigger_mpi()&quot;</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;#include &quot;Generators/Trigger.h&quot;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;#include &quot;Pythia8/Pythia.h&quot;</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;o2::eventgen::DeepTrigger</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  trigger_mpi(int mpiMin = 5)</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;{</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;  return [mpiMin](void* interface, std::string name) -&gt; bool {</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;    if (!name.compare(&quot;pythia8&quot;)) {</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;      auto py8 = reinterpret_cast&lt;Pythia8::Pythia*&gt;(interface);</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;      return py8-&gt;info.nMPI() &gt;= mpiMin;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;    }</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    LOG(FATAL) &lt;&lt; &quot;Cannot define MPI for generator interface \&#39;&quot; &lt;&lt; name &lt;&lt; &quot;\&#39;&quot;;</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;    return false;</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;  };</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;}</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;```</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;### Pythia8 UserHooks</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;Pythia8 machinery allows the user to hook some code at various stages of the event-generation process. For details, please look at Pyhia8 manual.</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;http://home.thep.lu.se/~torbjorn/pythia82html/UserHooks.html</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;The interface is provided via a configuration macro, where the user will have to define a custom UserHooks according to the protocol defined by Pythia8. The macro will also have to provide a function to retrieve the pointer to the created custom UserHooks object.</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;This functionality might be of use for users who want to be able to steer the event-generation process from very deep inside the internal routines and want to veto some specific processes based on analysis of the status of Pythia8 at the various stages, i.e. veto events that do not have charm partons, before hadronisation of partons. This can save time in the event generation process as many steps can be skipped already at early time.</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;An example of a configuration macro is this one</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;```</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;//   usage: o2sim -g pythia8 --configKeyValue &quot;Pythia8.hooksFileName=pythia8_userhooks_charm.C&quot;</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;#include &quot;Generators/Trigger.h&quot;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;#include &quot;Pythia8/Pythia.h&quot;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;class UserHooksCharm : public Pythia8::UserHooks</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;{</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160; public:</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;  UserHooksCharm() = default;</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;  ~UserHooksCharm() = default;</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;  bool canVetoPartonLevel() override { return true; };</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;  bool doVetoPartonLevel(const Pythia8::Event&amp; event) override</div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;  {</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;    for (int ipa = 0; ipa &lt; event.size(); ++ipa) {</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;      if (abs(event[ipa].id()) != 4)</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;        continue;</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;      if (fabs(event[ipa].y()) &gt; 1.5)</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;        continue;</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;      return false;</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;    }</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;    return true;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  };</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;};</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;Pythia8::UserHooks*</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  pythia8_userhooks_charm()</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;{</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;  return new UserHooksCharm();</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;```</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;### Pythia6 interface</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;A new Pythia6 interface is provided via GeneratorPythia6. This complies with the o2::eventgen::Generator protocol, and hence the user is allowed to use all the trigger functionalities. The class can also be used for DeepTriggers as this modified macro shows.</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;```</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;//   usage: o2sim --trigger external --extTrgFile trigger_mpi.C</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;// options:                          --extTrgFunc &quot;trigger_mpi()&quot;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;#include &quot;Generators/Trigger.h&quot;</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;#include &quot;Pythia8/Pythia.h&quot;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;#include &quot;TPythia6.h&quot;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;o2::eventgen::DeepTrigger</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;  trigger_mpi(int mpiMin = 15)</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;{</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;  return [mpiMin](void* interface, std::string name) -&gt; bool {</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;    int nMPI = 0;</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    if (!name.compare(&quot;pythia8&quot;)) {</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;      auto py8 = reinterpret_cast&lt;Pythia8::Pythia*&gt;(interface);</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;      nMPI = py8-&gt;info.nMPI();</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;    }</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;    else if (!name.compare(&quot;pythia6&quot;)) {</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;      auto py6 = reinterpret_cast&lt;TPythia6*&gt;(interface);</div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;      nMPI = py6-&gt;GetMSTI(31);</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;    }</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;    else</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;      LOG(FATAL) &lt;&lt; &quot;Cannot define MPI for generator interface \&#39;&quot; &lt;&lt; name &lt;&lt; &quot;\&#39;&quot;;</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;    return nMPI &gt;= mpiMin;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;  };</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;}</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;```</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;## Development</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;# Documentation of the digitization step &lt;a name=&quot;DigitSection&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;Digitization - the transformation of hits produced in the transport simulation to electronics detector output - is steered by the `o2-sim-digitizer-workflow` executable. The executable is implemented as a [DPL workflow] (https://github.com/AliceO2Group/AliceO2/blob/dev/Framework/Core/README.md). The main components in this workflow are:</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;- **A SimReader** process, responsible to analyze available simulation information/kinematics and to setup the digitization context, which describes things such as the structure of the timeframe (bunch cross properties and interaction rate) as well as how to combine different background and signal hits.</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;- **Digitizer processors** per detector, responsible for the actual digitization upon receiving the digitization context from the SimReader.</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;- **IO processors** per detector, responsible to write digits to files.</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;- **GRP updater**, a process to update the GRP file with information aquired in digitization.</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;## Usage overview:</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;* **Quick start example:** A minimal invocation is of the form </div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;    ```o2-sim-digitizer-workflow [--sims foo] -b``` </div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;    which would launch the digitization phase for all detectors that took part in a simulation stored under simulation prefix `foo` (default o2sim) and will digitize all events with a default bunch crossing structure. All digitizer will run in parallel to each other.</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;* **A more advanced example:** </div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;    ```o2-sim-digitizer-workflow --sims bkg,sgn --interactionRate 1e6 --onlyDet TPC,ITS -b``` </div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;    which would launch the digitization phase for TPC and ITS with a custom LHC interactionRate. Moreover, this example does</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;    summation of digits coming from background (prefix bkg) as well as signal (prefix sgn) transport simulations.</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;* **Generated output**: The digitization process creates the following output files:</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;     </div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;| File                  | Description                                                                            |</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;| --------------------- | -------------------------------------------------------------------------------------- |</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;| `collisioncontext.root` | Contains information about the collision/digitization context used in this digitization. Keeps the list of input files and how collisions were composed for the digits embedding process and time stamps where assigned.  |</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;| `XXXdigits.root` | Typically one digit file per detector XXX in a timeframe format. The file also typically contains mappings of digit indices to   MC labels. |</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;| `o2simdigitizerworkflow_configuration.ini` | Summary of parameters used in the digitization process. |</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;* **Main command line options**: The following major options are available:</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;| Option                | Description                                                                            |</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;| --------------------- | -------------------------------------------------------------------------------------- |</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;| -h,--help     | Prints the list of possible command line options and their default values.           |</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;| --sims | Comma separated list of simulation prefixes that should be overlaid/embedded. Example `--sims background,signal` where `background` and `signal` refer to transport simulation productions. Final collisions will be composed from both of them (in a round robin fashion). See separate section about [Embedding](#Embedding) for more details. If just one prefix is given, normal digitization without overlay will be done. |</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;| --tpc-lanes | Number of parallel digitizers for TPC, which has a special attention due an increased data rate compared to other detectors. | |</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;| --interactionRate | Total hadronic interaction rate (Hz). |</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;| --bcPatternFile | Interacting BC pattern file chaning the default bunch crossing pattern. |</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;| --onlyDet | Comma separated list of detectors to digitize. (Default is all) |</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;| --skipDet | Comma separed list of detectors to exclude. |</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;| --incontext | Name of context file. Useful for reusing a context from a previous run when we split the processing detectorwise. |</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;| --outcontext | Specify name of contextfile to produce. |</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;| --simFileQED | Optional special QED hit file to include effect from QED effects into digitization. |</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;## Embedding &lt;a name=&quot;Embedding&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;## Monte Carlo Labels &lt;a name=&quot;MCLabels&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;We can associate digits to tracks/particles of the original transport simulation, so as to keep provenance information of how</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;digits were triggered. This information can be passed forward to reconstruction and analysis and used to study reconstruction efficiencies etc.</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;To this end, a special data object `MCCompLabel` is offered, which allows to encapsulate the identifiers of track, event and source kinematics files. </div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;```c++</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;  MCCompLabel(int trackID, int evID, int srcID, bool fake = false)</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;```</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;This information should be enough to lookup and load the precise Monte Carlo track ([see here](#MCReader)).</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;Association of digits to an arbitrary number of labels is done via filling a **separate** and **dedicated** container called `MCTruthContainer` which is written as a separate branch to the output file, next to the branch for digits. This has the advantage that digits may be kept as close as possible to the raw data and we can have arbitrary number of labels at a minimal memory cost.</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;The mechanics is as follows: For a collection of digits created for detector `foo`</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;```c++</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;std::vector&lt;o2::foo::Digits&gt; mDigits;</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;```</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;we keep a separate container of labels of type:</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;```c++</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;o2::dataformats::MCTruthContainer&lt;o2::dataformats::MCCompLabel&gt; mLabelContainer;</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;```</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;Querying the labels works by positional correspondance: Labels for the digit at position `pos` can be accessed in the following way:</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;```c++</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;const auto&amp; digit = mDigits[pos];</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;// returns an iterable view of labels</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;const auto&amp; labels_for_digit = mLabelContainer.getLabels(pos);</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;// iterate over labels</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;for (auto&amp; label : labels_for_digit) {</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;   // process label</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;}</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;```</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;If positional correspondance is too weak, one may eventualy choose to record the corresponding data index in the labelcontainer inside the digit itself:</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;```c++</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;const auto&amp; digit = mDigits[pos];</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;// returns an iterable view of labels</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;const auto&amp; labels_for_digit = mLabelContainer.getLabels(digit.labelindex);</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;// iterate over labels</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;for (auto&amp; label : labels_for_digit) {</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;   // process label</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;}</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;```</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;## Accessing Monte Carlo kinematics after the digitization phase &lt;a name=&quot;MCReader&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;After digitization is done, one can use the `MCKinematicsReader` class to load and access the Monte Carlo tracks.</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;The MCKinematicsReader needs the digitization context file, generated during digitization. Once initialized it can return the tracks associated to a Monte Carlo label.</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;A typical code example may be</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;```c++</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;// init the reader from the context</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;o2::steer::MCKinematicsReader reader(&quot;collisioncontext.root&quot;);</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;// load digits from the digits file --&gt; save in alldigits</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;// load the label container from the digits file --&gt; save in labelcontainer</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;// this is simply iterating over all the digits and querying the tracks that contributed to these digits</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;</div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;for (int pos = 0; pos &lt; alldigits.size(); ++pos) {</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;  const auto&amp; digit = alldigits[pos];</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;  const auto&amp; labels_for_digit = labelcontainer.getLabels(pos);</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;  // iterate over labels</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;  for (auto&amp; label : labels_for_digit) {</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;     track = reader.getTrack(label);</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;     // do something with the track</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;  }</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;}</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;```</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;# Simulation tutorials/examples &lt;a name=&quot;Examples&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;Some examples for the usage of simulation and digitization are collected in an [examples folder](../run/SimExamples).</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;Other helpful resources are the scripts used for regression testing in [prodtests](../prodtests). </div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;| Example               | Short Description                                                                      |</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;| --------------------- | -------------------------------------------------------------------------------------- |</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;| [AliRoot_Hijing](../run/SimExamples/AliRoot_Hijing) | Example showing how to use Hijing from AliRoot for event generation |</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;| [Adaptive_Pythia8](../run/SimExamples/Adaptive_Pythia8) | Complex example showing **generator configuration for embedding** that cat adapt the response based on the background event |</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;| [Signal_ImpactB](../run/SimExamples/Signal_ImpactB) | Example showing **generator configuration for embedding** that cat adapt to the impact parameter of the background event |</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;| [HepMC_STARlight](../run/SimExamples/HepMC_STARlight) | Simple example showing **generator configuration** that runs a standalone `STARlight` generation that couples to the `o2` via a `HepMC` file |</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;| [Jet_Embedding_Pythia](../run/SimExamples/Jet_Embedding_Pythia8) | Complex example showing **generator configuration**, **digitization embedding**, **MCTrack access** |</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;| [sim_challenge.sh](../prodtests/sim_challenge.sh) | Basic example doing a **simple transport, digitization, reconstruction pipeline** on the full dectector. All stages use parallelism. |</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;| [sim_performance.sh](../prodtests/sim_performance_test.sh) | Basic example for serial transport and linearized digitization sequence (one detector after the other). Serves as standard performance candle. |  </div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d4/d6b/DetectorSimulation_8md.html">DetectorSimulation.md</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:32 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
