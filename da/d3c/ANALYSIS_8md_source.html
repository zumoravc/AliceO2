<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: /home/travis/build/AliceO2Group/AliceO2/Framework/Core/ANALYSIS.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('da/d3c/ANALYSIS_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/travis/build/AliceO2Group/AliceO2/Framework/Core/ANALYSIS.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../da/d3c/ANALYSIS_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;!-- doxy</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\page refFrameworkCoreANALYSIS Core ANALYSIS</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/doxy --&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;##  Core ANALYSIS</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;This document is WIP and provides an idea of what kind of API to expect from the DPL enabled analysis framework. APIs are neither final nor fully implemented in O2.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;# Analysis Task infrastructure on top of DPL</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;In order to simplify analysis we have introduced an extension to DPL which allows to describe an Analysis in the form of a collection of AnalysisTask.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;In order to create its own task, as user needs to create your own Task deriving from AnalysisTask.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;```cpp</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;};</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;```</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;such a task can then be added to a workflow via the `adaptAnalysisTask` helper. A full blown example can be built with:</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;```cpp</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;#include &quot;Framework/runDataProcessing.h&quot;</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;#include &quot;Framework/AnalysisTask.h&quot;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;};</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;defineDataProcessing() {</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;  return {</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;    adaptAnalysisTask&lt;MyTask&gt;(&quot;my-task-unique-name&quot;);</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;  };</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;}</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;```</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;&gt; **Implementation details**: `AnalysisTask` is simply a `struct`. Since `struct` default inheritance policy is `public`, we can omit specifying it when declaring MyTask.</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;&gt;</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;&gt; `AnalysisTask` will not actually provide any virtual method, as the `adaptAnalysis` helper relies on template argument matching to discover the properties of the task. It will come clear in the next paragraph how this allow is used to avoid the proliferation of data subscription methods.   </div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;## Processing data</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;### Simple subscriptions</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;Once you have an `AnalysisTask` derived type, the most generic way which you can use to process data is to provide a `process` method for it.</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;Depending on the arguments of such a function, you get to iterate on different parts of the AOD content.</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;For example:</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;```cpp</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;  void process(o2::aod::Tracks const&amp; tracks) {</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;    ...</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;  }</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;};</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;```</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;will allow you to get a per time frame collection of tracks. You can then iterate on the tracks using the syntax:</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;```cpp</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;for (auto &amp;track : tracks) {</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;  tracks.alpha();</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;}</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;```</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;Alternatively you can subscribe to tracks one by one via (notice the missing `s`):</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;```cpp</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;  void process(o2::aod::Track const&amp; track) {</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;    ...</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;  }</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;};</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;```</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;This has the advantage that you might be able to benefit from vectorization / parallelization.</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;&gt; **Implementation notes**: as mentioned before, the arguments of the process method are inspected using template argument matching. This way the system knows at compile time what data types are requested by a given `process` method and can create the relevant DPL data descriptions. </div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;&gt;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;&gt; The distinction between `Tracks` and `Track` above is simply that one refers to the whole collection, while the second is an alias to `Tracks::iterator`.  Notice that we assume that each collection is of type `o2::soa::Table` which carries meta data about the dataOrigin and dataDescription to be used by DPL to subscribe to the associated data stream.</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;### Navigating data associations</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;For performance reasons, data is organized in a set of flat table and navigation between objects of different tables has to be expressed explicitly in the `process` method. So if you want to get all the tracks for a specific collision, you will have to implement:</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;```cpp</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;void process(o2::aod::Collision const&amp; collision, o2::aod::Tracks &amp;tracks) {</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;...</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;}</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;```</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;the above will be called once per collision found in the time frame, and `tracks` will allow you to iterate on all the tracks associated to the given collision.</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;Alternatively, you might not require to have all the tracks at once and you could do with:</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;```cpp</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;void process(o2::aod::Collection const&amp; collision, o2::aod::Track const&amp; track) {</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;}</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;```</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;also in this case the advantage is that your code might be up for parallelization and vectorization.</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;Notice that you are not limited to two different collections, but you could specify more. E.g.: </div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;```cpp</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;void process(o2::aod::Collection const&amp; collision, o2::aod::V0 const&amp; v0, o2::aod::Tracks const&amp; tracks) {</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;}</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;```</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;will be invoked for each v0 associated to a given collision and you will be given the tracks associated to it.</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;This means that each subsequent argument is associated to all the one preceding it.</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;### Processing related tables</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;For performance reasons, sometimes it&#39;s a good idea to split data in separate tables, so that once can request only the subset which is required for a given task. For example, so far the track related information is split in three tables: `Tracks`, `TrackCovs`, `TrackExtras`.</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;However you might need to get all the information at once. This can be done by asking for a `Join` table in the process method:</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;```cpp</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  void process(Join&lt;Tracks, TracksExtras&gt; const&amp; mytracks) {</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;    for (auto&amp; track : mytracks) {</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;      if (track.length()) {  // from TrackExtras</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;        tracks.alpha();      // from Tracks</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;      }</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;    }</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;  }</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;}</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;```</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;## Creating new collections</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;In order to create new collections of objects, you need two things. First of all you need to define a datatype for it, then you need to specify that your analysis task will create such an object. Notice that in a given workflow, only one task is allowed to create a given type of object.</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;### Introducing a new data type</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;In order to define the datatype you need to use `DEFINE_SOA_COLUMN` and `DEFINE_SOA_TABLE` helpers, defined in `ASoA.h`. Assuming you want to extend the standard AOD format you will also need `Framework/AnalysisDataModel.h`. For example, to define an extra table where to define phi and eta, you first need to define the two columns:</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;```cpp</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;#include &quot;Framework/ASoA.h&quot;</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;#include &quot;Framework/AnalysisDataModel.h&quot;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;namespace o2::aod {</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;namespace etaphi {</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;DECLARE_SOA_COLUMN(Eta, eta, float, &quot;fEta&quot;);</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;DECLARE_SOA_COLUMN(Phi, phi, float, &quot;fPhi&quot;);</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;}</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;}</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;```</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;and then you put them together in a table:</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;```cpp</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;namespace o2::aod {</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;DECLARE_SOA_TABLE(EtaPhi, &quot;AOD&quot;, &quot;ETAPHI&quot;,</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;                  etaphi::Eta, etaphi::Phi);</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;}</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;```</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;Notice that tables are actually just a collections of columns.</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;### Creating objects for a new data type</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;Once you have the new data type defined, you can have a task producing it, by using the `Produces` helper:</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;```cpp</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  Produces&lt;o2::aod::EtaPhi&gt; etaphi;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;  void process(o2::aod::Track const&amp; track) {</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    etaphi(calculateEta(track), calculatePhi(track));</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;  }</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;};</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;```</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;the `etaphi` object is a functor that will effectively act as a cursor which allows to populate the `EtaPhi` table. Each invocation of the functor will create a new row in the table, using the arguments as contents of the given column. By default the arguments must be given in order, but one can give them in any order by using the correct column type. E.g. in the example above:</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;```cpp</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;etaphi(track::Phi(calculatePhi(track), track::Eta(calculateEta(track)));</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;```</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;### Adding dynamic columns to a data type</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;Sometimes columns are not backed by actual persisted data, but they are merely</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;derived from it. For example you might want to have different representations</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;(e.g. spherical, cylindrical) for a given persistent representation. You can</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;do that by using the `DECLARE_SOA_DYNAMIC_COLUMN` macro.</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;```cpp</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;namespace point {</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;DECLARE_SOA_COLUMN(X, x, float, &quot;fX&quot;);</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;DECLARE_SOA_COLUMN(Y, y, float, &quot;fY&quot;);</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;}</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;DECLARE_SOA_DYNAMIC_COLUMN(R2, r2, [](float x, float y) { return x*x + y+y; });</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;DECLARE_SOA_TABLE(Point, &quot;MISC&quot;, &quot;POINT&quot;, X, Y, (R2&lt;X,Y&gt;));</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;```</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;Notice how the dynamic column is defined as a stand alone column and binds to X and Y</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;only when you attach it as part of a table.</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;### Executing a finalization method, post run</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;Sometimes it&#39;s handy to perform an action when all the data has been processed, for example executing a fit on a histogram we filled during the processing. This can be done by implementing the postRun method.</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;### Creating histograms</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;New tables are not the only kind on objects you want to create, but most likely you would like to fill histograms associated to the objects you have calculated.</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;You can do so by using the `Histogram` helper:</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;```cpp</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;  Histogram etaHisto;</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;  void process(o2::aod::EtaPhi const&amp; etaphi) {</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;    etaHisto.fill(etaphi.eta());</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;  }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;};</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;```</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;# Creating new columns in a declarative way</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;Besides the `Produces` helper, which allows you to create a new table which can be reused by others, there is another way to define a single column,  via the `Defines` helper.</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;```cpp</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;  Defines&lt;track::Eta&gt; eta = track::alpha;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;};</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;```</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;## Filtering and partitioning data</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;Given a process function, one can of course define a filter using an if condition:</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160;```cpp</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;  void process(o2::aod::EtaPhi const&amp; etaphi) {</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160;    if (etaphi.phi() &gt; 1 &amp;&amp; etaphi.phi &lt; 1) {</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160;      ...</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160;    }</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160;  }</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160;};</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;```</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160;</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;however this has the disadvantage that the filtering will be done for every</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;task which has similar or more restrictive conditions. By declaring your</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;filters upfront you can not only simplify your code, but allow the framework to</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;optimize your processing.  To do so, we provide two helpers: `Filter` and</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;`Partition`. </div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;### Upfront filtering</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;The most common kind of filtering is when you process objects only if one of its</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;properties passes a certain criteria. This can be specified with the `Filter` helper.</div><div class="line"><a name="l00260"></a><span class="lineno">  260</span>&#160;</div><div class="line"><a name="l00261"></a><span class="lineno">  261</span>&#160;```cpp</div><div class="line"><a name="l00262"></a><span class="lineno">  262</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00263"></a><span class="lineno">  263</span>&#160;  Filter&lt;Tracks&gt; ptFilter = track::pt &gt; 1;</div><div class="line"><a name="l00264"></a><span class="lineno">  264</span>&#160;</div><div class="line"><a name="l00265"></a><span class="lineno">  265</span>&#160;  void process(Tracks const &amp;filteredTracks) {</div><div class="line"><a name="l00266"></a><span class="lineno">  266</span>&#160;    for (auto&amp; track : filteredTracks) {</div><div class="line"><a name="l00267"></a><span class="lineno">  267</span>&#160;    }</div><div class="line"><a name="l00268"></a><span class="lineno">  268</span>&#160;  }</div><div class="line"><a name="l00269"></a><span class="lineno">  269</span>&#160;};</div><div class="line"><a name="l00270"></a><span class="lineno">  270</span>&#160;```</div><div class="line"><a name="l00271"></a><span class="lineno">  271</span>&#160;</div><div class="line"><a name="l00272"></a><span class="lineno">  272</span>&#160;filteredTracks will contain only the tracks in the table which pass the condition `track::pt &gt; 1`. </div><div class="line"><a name="l00273"></a><span class="lineno">  273</span>&#160;</div><div class="line"><a name="l00274"></a><span class="lineno">  274</span>&#160;You can specify multiple filters which will be applied in a sequence effectively resulting in the intersection of all them.</div><div class="line"><a name="l00275"></a><span class="lineno">  275</span>&#160;</div><div class="line"><a name="l00276"></a><span class="lineno">  276</span>&#160;You can also specify filters on associated quantities:</div><div class="line"><a name="l00277"></a><span class="lineno">  277</span>&#160;</div><div class="line"><a name="l00278"></a><span class="lineno">  278</span>&#160;```cpp</div><div class="line"><a name="l00279"></a><span class="lineno">  279</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00280"></a><span class="lineno">  280</span>&#160;  Filter&lt;Collisions&gt; collisionFilter = max(track::pt) &gt; 1;</div><div class="line"><a name="l00281"></a><span class="lineno">  281</span>&#160;</div><div class="line"><a name="l00282"></a><span class="lineno">  282</span>&#160;  void process(Collsions const &amp;filteredCollisions) {</div><div class="line"><a name="l00283"></a><span class="lineno">  283</span>&#160;    for (auto&amp; collision: collisions) {</div><div class="line"><a name="l00284"></a><span class="lineno">  284</span>&#160;    ...</div><div class="line"><a name="l00285"></a><span class="lineno">  285</span>&#160;    }</div><div class="line"><a name="l00286"></a><span class="lineno">  286</span>&#160;  }</div><div class="line"><a name="l00287"></a><span class="lineno">  287</span>&#160;};</div><div class="line"><a name="l00288"></a><span class="lineno">  288</span>&#160;```</div><div class="line"><a name="l00289"></a><span class="lineno">  289</span>&#160;</div><div class="line"><a name="l00290"></a><span class="lineno">  290</span>&#160;will process all the collisions which have at least one track with `pt &gt; 1`.</div><div class="line"><a name="l00291"></a><span class="lineno">  291</span>&#160;</div><div class="line"><a name="l00292"></a><span class="lineno">  292</span>&#160;### Partitioning your inputs</div><div class="line"><a name="l00293"></a><span class="lineno">  293</span>&#160;</div><div class="line"><a name="l00294"></a><span class="lineno">  294</span>&#160;Filtering is not the only kind of conditional processing one wants to do. Sometimes you need to divide your data in two or more partitions. This is done via the `Partition` helper:</div><div class="line"><a name="l00295"></a><span class="lineno">  295</span>&#160;</div><div class="line"><a name="l00296"></a><span class="lineno">  296</span>&#160;```cpp</div><div class="line"><a name="l00297"></a><span class="lineno">  297</span>&#160;using namespace o2::aod;</div><div class="line"><a name="l00298"></a><span class="lineno">  298</span>&#160;</div><div class="line"><a name="l00299"></a><span class="lineno">  299</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00300"></a><span class="lineno">  300</span>&#160;  Partition&lt;Tracks&gt; leftTracks = track::eta &lt; 0;</div><div class="line"><a name="l00301"></a><span class="lineno">  301</span>&#160;  Partition&lt;Tracks&gt; rightTracks = track::eta &gt;= 0;</div><div class="line"><a name="l00302"></a><span class="lineno">  302</span>&#160;</div><div class="line"><a name="l00303"></a><span class="lineno">  303</span>&#160;  void process(Tracks const &amp;tracks) {</div><div class="line"><a name="l00304"></a><span class="lineno">  304</span>&#160;    for (auto&amp; left : leftTracks(tracks)) {</div><div class="line"><a name="l00305"></a><span class="lineno">  305</span>&#160;      for (auto&amp; right : rightTracks(tracks)) {</div><div class="line"><a name="l00306"></a><span class="lineno">  306</span>&#160;        ...</div><div class="line"><a name="l00307"></a><span class="lineno">  307</span>&#160;      }</div><div class="line"><a name="l00308"></a><span class="lineno">  308</span>&#160;    }</div><div class="line"><a name="l00309"></a><span class="lineno">  309</span>&#160;  }</div><div class="line"><a name="l00310"></a><span class="lineno">  310</span>&#160;};</div><div class="line"><a name="l00311"></a><span class="lineno">  311</span>&#160;```</div><div class="line"><a name="l00312"></a><span class="lineno">  312</span>&#160;</div><div class="line"><a name="l00313"></a><span class="lineno">  313</span>&#160;i.e. `Filter` is applied to the objects before passing them to the `process` method, while `Select` objects can be used to do further reduction inside the `process` method itself. </div><div class="line"><a name="l00314"></a><span class="lineno">  314</span>&#160;</div><div class="line"><a name="l00315"></a><span class="lineno">  315</span>&#160;### Filtering and partitioning together</div><div class="line"><a name="l00316"></a><span class="lineno">  316</span>&#160;</div><div class="line"><a name="l00317"></a><span class="lineno">  317</span>&#160;Of course it should be possible to filter and partition data in the same task. The way this works is that multiple `Filter`s are logically ANDed together and then they will get anded with the OR of all the `Select` specified selections.</div><div class="line"><a name="l00318"></a><span class="lineno">  318</span>&#160;</div><div class="line"><a name="l00319"></a><span class="lineno">  319</span>&#160;### Configuring filters</div><div class="line"><a name="l00320"></a><span class="lineno">  320</span>&#160;</div><div class="line"><a name="l00321"></a><span class="lineno">  321</span>&#160;One of the features of the current framework is the ability to customize on the fly cuts and selection. The idea is to allow that by having a `configurable(&quot;mnemonic-name-of-the-parameter&quot;)` helper which can be used to refer to configurable options. The previous example will then become:</div><div class="line"><a name="l00322"></a><span class="lineno">  322</span>&#160;</div><div class="line"><a name="l00323"></a><span class="lineno">  323</span>&#160;```cpp</div><div class="line"><a name="l00324"></a><span class="lineno">  324</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00325"></a><span class="lineno">  325</span>&#160;  Filter&lt;Collisions&gt; collisionFilter = max(track::pt) &gt; configurable&lt;float&gt;(&quot;my-pt-cut&quot;);</div><div class="line"><a name="l00326"></a><span class="lineno">  326</span>&#160;</div><div class="line"><a name="l00327"></a><span class="lineno">  327</span>&#160;  void process(Collsions const &amp;filteredCollisions) {</div><div class="line"><a name="l00328"></a><span class="lineno">  328</span>&#160;    for (auto&amp; collision: collisions) {</div><div class="line"><a name="l00329"></a><span class="lineno">  329</span>&#160;    ...</div><div class="line"><a name="l00330"></a><span class="lineno">  330</span>&#160;    }</div><div class="line"><a name="l00331"></a><span class="lineno">  331</span>&#160;  }</div><div class="line"><a name="l00332"></a><span class="lineno">  332</span>&#160;};</div><div class="line"><a name="l00333"></a><span class="lineno">  333</span>&#160;```</div><div class="line"><a name="l00334"></a><span class="lineno">  334</span>&#160;</div><div class="line"><a name="l00335"></a><span class="lineno">  335</span>&#160;### Getting combinations (pairs, triplets, ...)</div><div class="line"><a name="l00336"></a><span class="lineno">  336</span>&#160;To get combinations of distinct tracks, helper functions from `ASoAHelpers.h` can be used. Presently, there are 3 combinations policies available: strictly upper, upper and full. `CombinationsStrictlyUpperPolicy` is applied by default if all tables are of the same type, otherwise `FullIndexPolicy` is applied.</div><div class="line"><a name="l00337"></a><span class="lineno">  337</span>&#160;</div><div class="line"><a name="l00338"></a><span class="lineno">  338</span>&#160;```cpp</div><div class="line"><a name="l00339"></a><span class="lineno">  339</span>&#160;combinations(tracks, tracks); // equivalent to combinations(CombinationsStrictlyUpperIndexPolicy(tracks, tracks));</div><div class="line"><a name="l00340"></a><span class="lineno">  340</span>&#160;combinations(filter, tracks, covs); // equivalent to combinations(CombinationsUpperIndexPolicy(tracks, covs), filter, tracks, covs);</div><div class="line"><a name="l00341"></a><span class="lineno">  341</span>&#160;```</div><div class="line"><a name="l00342"></a><span class="lineno">  342</span>&#160;</div><div class="line"><a name="l00343"></a><span class="lineno">  343</span>&#160;The number of elements in a combination is deduced from the number of arguments passed to `combinations()` call. For example, to get pairs of tracks from the same source, one must specify `tracks` table twice:</div><div class="line"><a name="l00344"></a><span class="lineno">  344</span>&#160;</div><div class="line"><a name="l00345"></a><span class="lineno">  345</span>&#160;```cpp</div><div class="line"><a name="l00346"></a><span class="lineno">  346</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00347"></a><span class="lineno">  347</span>&#160;</div><div class="line"><a name="l00348"></a><span class="lineno">  348</span>&#160;  void process(Tracks const&amp; tracks) {</div><div class="line"><a name="l00349"></a><span class="lineno">  349</span>&#160;    for (auto&amp; [t0, t1] : combinations(CombinationsStrictlyUpperIndexPolicy(tracks, tracks))) {</div><div class="line"><a name="l00350"></a><span class="lineno">  350</span>&#160;      float pt = t0.pt();</div><div class="line"><a name="l00351"></a><span class="lineno">  351</span>&#160;      ...</div><div class="line"><a name="l00352"></a><span class="lineno">  352</span>&#160;    }</div><div class="line"><a name="l00353"></a><span class="lineno">  353</span>&#160;  }</div><div class="line"><a name="l00354"></a><span class="lineno">  354</span>&#160;};</div><div class="line"><a name="l00355"></a><span class="lineno">  355</span>&#160;```</div><div class="line"><a name="l00356"></a><span class="lineno">  356</span>&#160;</div><div class="line"><a name="l00357"></a><span class="lineno">  357</span>&#160;The combination can consist of elements from different tables (of different kinds):</div><div class="line"><a name="l00358"></a><span class="lineno">  358</span>&#160;</div><div class="line"><a name="l00359"></a><span class="lineno">  359</span>&#160;```cpp</div><div class="line"><a name="l00360"></a><span class="lineno">  360</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00361"></a><span class="lineno">  361</span>&#160;</div><div class="line"><a name="l00362"></a><span class="lineno">  362</span>&#160;  void process(Tracks const&amp; tracks, TracksCov const&amp; covs) {</div><div class="line"><a name="l00363"></a><span class="lineno">  363</span>&#160;    for (auto&amp; [t0, c1] : combinations(CombinationsFullIndexPolicy(tracks, covs))) {</div><div class="line"><a name="l00364"></a><span class="lineno">  364</span>&#160;      ...</div><div class="line"><a name="l00365"></a><span class="lineno">  365</span>&#160;    }</div><div class="line"><a name="l00366"></a><span class="lineno">  366</span>&#160;  }</div><div class="line"><a name="l00367"></a><span class="lineno">  367</span>&#160;};</div><div class="line"><a name="l00368"></a><span class="lineno">  368</span>&#160;```</div><div class="line"><a name="l00369"></a><span class="lineno">  369</span>&#160;</div><div class="line"><a name="l00370"></a><span class="lineno">  370</span>&#160;One can get combinations of elements with the same value in a given column. Input tables do not need to be the same but each table must contain the column used for categorizing. Additionally, you can specify a value to be skipped for grouping as well as the number of elements to be matched with first element in a combination. Again, full, strictly upper and upper policies are available:</div><div class="line"><a name="l00371"></a><span class="lineno">  371</span>&#160;</div><div class="line"><a name="l00372"></a><span class="lineno">  372</span>&#160;```cpp</div><div class="line"><a name="l00373"></a><span class="lineno">  373</span>&#160;for (auto&amp; [c0, c1] : combinations(CombinationsBlockStrictlyUpperIndexPolicy(&quot;fRunNumber&quot;, 3, -1, collisions, collisions))) {</div><div class="line"><a name="l00374"></a><span class="lineno">  374</span>&#160;  // Pairs of collisions with same fRunNumber, max 3 pairs for each element in a given &quot;fRunNumber&quot; bin. Entries with fRunNumber == -1 are skipped.</div><div class="line"><a name="l00375"></a><span class="lineno">  375</span>&#160;}</div><div class="line"><a name="l00376"></a><span class="lineno">  376</span>&#160;for (auto&amp; [c0, t1] : combinations(CombinationsBlockFullIndexPolicy(&quot;fX&quot;, 200, -1, collisions, tracks)));</div><div class="line"><a name="l00377"></a><span class="lineno">  377</span>&#160;```</div><div class="line"><a name="l00378"></a><span class="lineno">  378</span>&#160;</div><div class="line"><a name="l00379"></a><span class="lineno">  379</span>&#160;For better performance, if the same table is used, `Block{Full,StrictlyUpper,Upper}SameIndex` policies should be preferred. `selfCombinations()` are a shortuct to apply StrictlyUpperSameIndex policy:</div><div class="line"><a name="l00380"></a><span class="lineno">  380</span>&#160;</div><div class="line"><a name="l00381"></a><span class="lineno">  381</span>&#160;```cpp</div><div class="line"><a name="l00382"></a><span class="lineno">  382</span>&#160;for (auto&amp; [c0, c1] : combinations(CombinationsBlockFullSameIndexPolicy(&quot;fRunNumber&quot;, 3, -1, collisions, collisions)));</div><div class="line"><a name="l00383"></a><span class="lineno">  383</span>&#160;for (auto&amp; [c0, c1] : selfCombinations(&quot;fRunNumber&quot;, 3, -1, collisions, collisions)) {</div><div class="line"><a name="l00384"></a><span class="lineno">  384</span>&#160;  // same as: combinations(CombinationsBlockStrictlyUpperSameIndexPolicy(&quot;fRunNumber&quot;, 3, -1, collisions, collisions));</div><div class="line"><a name="l00385"></a><span class="lineno">  385</span>&#160;}</div><div class="line"><a name="l00386"></a><span class="lineno">  386</span>&#160;```</div><div class="line"><a name="l00387"></a><span class="lineno">  387</span>&#160;</div><div class="line"><a name="l00388"></a><span class="lineno">  388</span>&#160;It will be possible to specify a filter for a combination as a whole, and only matching combinations will be then output. Currently, the filter is applied to each element separately. Note that for filter version the input tables are mentioned twice, both in policy constructor and in `combinations()` call itself.</div><div class="line"><a name="l00389"></a><span class="lineno">  389</span>&#160;</div><div class="line"><a name="l00390"></a><span class="lineno">  390</span>&#160;```cpp</div><div class="line"><a name="l00391"></a><span class="lineno">  391</span>&#160;struct MyTask : AnalysisTask {</div><div class="line"><a name="l00392"></a><span class="lineno">  392</span>&#160;</div><div class="line"><a name="l00393"></a><span class="lineno">  393</span>&#160;  void process(Tracks const&amp; tracks1, Tracks const&amp; tracks2) {</div><div class="line"><a name="l00394"></a><span class="lineno">  394</span>&#160;    Filter triplesFilter = track::eta &lt; 0;</div><div class="line"><a name="l00395"></a><span class="lineno">  395</span>&#160;    for (auto&amp; [t0, t1, t2] : combinations(CombinationsFullIndexPolicy(tracks1, tracks2, tracks2), triplesFilter, tracks1, tracks2, tracks2)) {</div><div class="line"><a name="l00396"></a><span class="lineno">  396</span>&#160;      // Triples of tracks, each of them with eta &lt; 0</div><div class="line"><a name="l00397"></a><span class="lineno">  397</span>&#160;      ...</div><div class="line"><a name="l00398"></a><span class="lineno">  398</span>&#160;    }</div><div class="line"><a name="l00399"></a><span class="lineno">  399</span>&#160;  }</div><div class="line"><a name="l00400"></a><span class="lineno">  400</span>&#160;};</div><div class="line"><a name="l00401"></a><span class="lineno">  401</span>&#160;```</div><div class="line"><a name="l00402"></a><span class="lineno">  402</span>&#160;</div><div class="line"><a name="l00403"></a><span class="lineno">  403</span>&#160;### Saving tables to file</div><div class="line"><a name="l00404"></a><span class="lineno">  404</span>&#160;</div><div class="line"><a name="l00405"></a><span class="lineno">  405</span>&#160;Produced tables can be saved to file as TTrees. This process is customized by various command line options of the internal-dpl-aod-writer. The options allow to specify which columns of which table are saved to which tree in which file.</div><div class="line"><a name="l00406"></a><span class="lineno">  406</span>&#160;</div><div class="line"><a name="l00407"></a><span class="lineno">  407</span>&#160;**Please be aware, that the functionality of these options is preliminary and might be changed in future.**</div><div class="line"><a name="l00408"></a><span class="lineno">  408</span>&#160;</div><div class="line"><a name="l00409"></a><span class="lineno">  409</span>&#160;The options to consider are:</div><div class="line"><a name="l00410"></a><span class="lineno">  410</span>&#160;</div><div class="line"><a name="l00411"></a><span class="lineno">  411</span>&#160;* --keep</div><div class="line"><a name="l00412"></a><span class="lineno">  412</span>&#160;* --res-file</div><div class="line"><a name="l00413"></a><span class="lineno">  413</span>&#160;* --ntfmerge</div><div class="line"><a name="l00414"></a><span class="lineno">  414</span>&#160;* --json-file</div><div class="line"><a name="l00415"></a><span class="lineno">  415</span>&#160;</div><div class="line"><a name="l00416"></a><span class="lineno">  416</span>&#160;</div><div class="line"><a name="l00417"></a><span class="lineno">  417</span>&#160;#### --keep</div><div class="line"><a name="l00418"></a><span class="lineno">  418</span>&#160;</div><div class="line"><a name="l00419"></a><span class="lineno">  419</span>&#160;`keep` is a comma-separated list of `DataOuputDescriptors`.</div><div class="line"><a name="l00420"></a><span class="lineno">  420</span>&#160;</div><div class="line"><a name="l00421"></a><span class="lineno">  421</span>&#160;`keep`</div><div class="line"><a name="l00422"></a><span class="lineno">  422</span>&#160;```csh</div><div class="line"><a name="l00423"></a><span class="lineno">  423</span>&#160;DataOuputDescriptor1,DataOuputDescriptor2, ...</div><div class="line"><a name="l00424"></a><span class="lineno">  424</span>&#160;```</div><div class="line"><a name="l00425"></a><span class="lineno">  425</span>&#160;</div><div class="line"><a name="l00426"></a><span class="lineno">  426</span>&#160;Each `DataOuputDescriptor` is a colon-separated list of 4 items</div><div class="line"><a name="l00427"></a><span class="lineno">  427</span>&#160;</div><div class="line"><a name="l00428"></a><span class="lineno">  428</span>&#160;`DataOuputDescriptor`</div><div class="line"><a name="l00429"></a><span class="lineno">  429</span>&#160;```csh</div><div class="line"><a name="l00430"></a><span class="lineno">  430</span>&#160;table:tree:columns:file</div><div class="line"><a name="l00431"></a><span class="lineno">  431</span>&#160;```</div><div class="line"><a name="l00432"></a><span class="lineno">  432</span>&#160;and instructs the internal-dpl-aod-writer, to save the columns `columns` of table `table` as TTree `tree` into files `file_x.root`, where `x` is an incremental number. The selected columns are saved as separate TBranches of TTree `tree`.</div><div class="line"><a name="l00433"></a><span class="lineno">  433</span>&#160;</div><div class="line"><a name="l00434"></a><span class="lineno">  434</span>&#160;By default `x` is incremented with every time frame. This behavior can be modified with the command line option `--ntfmerge`. The value of `ntfmerge` specifies the number of time frames to merge into one file. </div><div class="line"><a name="l00435"></a><span class="lineno">  435</span>&#160;</div><div class="line"><a name="l00436"></a><span class="lineno">  436</span>&#160;The first item of a `DataOuputDescriptor` (`table`) is mandatory and needs to be specified, otherwise the `DataOuputDescriptor` is ignored. The other three items are optional and are filled by default values if missing.</div><div class="line"><a name="l00437"></a><span class="lineno">  437</span>&#160;</div><div class="line"><a name="l00438"></a><span class="lineno">  438</span>&#160;The format of `table` is</div><div class="line"><a name="l00439"></a><span class="lineno">  439</span>&#160;</div><div class="line"><a name="l00440"></a><span class="lineno">  440</span>&#160;`table`</div><div class="line"><a name="l00441"></a><span class="lineno">  441</span>&#160;```csh</div><div class="line"><a name="l00442"></a><span class="lineno">  442</span>&#160;AOD/tablename/0</div><div class="line"><a name="l00443"></a><span class="lineno">  443</span>&#160;```</div><div class="line"><a name="l00444"></a><span class="lineno">  444</span>&#160;`tablename` is the name of the table as defined in the workflow definition.</div><div class="line"><a name="l00445"></a><span class="lineno">  445</span>&#160;</div><div class="line"><a name="l00446"></a><span class="lineno">  446</span>&#160;The format of `tree` is a simple string which names the TTree the table is saved to. If `tree` is not specified then `tablename` is used as TTree name.</div><div class="line"><a name="l00447"></a><span class="lineno">  447</span>&#160;</div><div class="line"><a name="l00448"></a><span class="lineno">  448</span>&#160;`columns` is a slash(/)-separated list of column names., e.g.</div><div class="line"><a name="l00449"></a><span class="lineno">  449</span>&#160;</div><div class="line"><a name="l00450"></a><span class="lineno">  450</span>&#160;`columns`</div><div class="line"><a name="l00451"></a><span class="lineno">  451</span>&#160;```csh</div><div class="line"><a name="l00452"></a><span class="lineno">  452</span>&#160;col1/col2/col3</div><div class="line"><a name="l00453"></a><span class="lineno">  453</span>&#160;```</div><div class="line"><a name="l00454"></a><span class="lineno">  454</span>&#160;The column names are expected to match column names of table `tablename` as defined in the respective workflow. Non-matching columns are ignored. The selected table columns are saved as separate TBranches with the same names as the corresponding table columns. If `columns` is not specified then all table columns are saved.</div><div class="line"><a name="l00455"></a><span class="lineno">  455</span>&#160;</div><div class="line"><a name="l00456"></a><span class="lineno">  456</span>&#160;`file` finally specifies the base name of the files the tables are saved to. The actual file names are composed as `file`_`x`.root, where `x` is an incremental number. If `file` is not specified the default file name is used. The default file name can be set with the command line option `--res-file`. However, if `res-file` is missing then the default file name is set to `AnalysisResults`.</div><div class="line"><a name="l00457"></a><span class="lineno">  457</span>&#160;</div><div class="line"><a name="l00458"></a><span class="lineno">  458</span>&#160;##### Dangling outputs</div><div class="line"><a name="l00459"></a><span class="lineno">  459</span>&#160;The `keep` option also accepts the string &quot;dangling&quot; (or any leading sub-string of it). In</div><div class="line"><a name="l00460"></a><span class="lineno">  460</span>&#160;this case all dangling output tables are saved. For the parameters `tree`, `columns`, and</div><div class="line"><a name="l00461"></a><span class="lineno">  461</span>&#160;`file` the default values ([see table below](#priorities)) are used.</div><div class="line"><a name="l00462"></a><span class="lineno">  462</span>&#160;</div><div class="line"><a name="l00463"></a><span class="lineno">  463</span>&#160;#### --ntfmerge</div><div class="line"><a name="l00464"></a><span class="lineno">  464</span>&#160;</div><div class="line"><a name="l00465"></a><span class="lineno">  465</span>&#160;`ntfmerge` specifies the number of time frames which are merged into a given root file. By default this value is set to 1. The actual file names are composed as `file`_`x`.root, where `x` is an incremental number. `x` is incremented by 1 at every `ntfmerge` time frame.</div><div class="line"><a name="l00466"></a><span class="lineno">  466</span>&#160;</div><div class="line"><a name="l00467"></a><span class="lineno">  467</span>&#160;#### --res-file</div><div class="line"><a name="l00468"></a><span class="lineno">  468</span>&#160;</div><div class="line"><a name="l00469"></a><span class="lineno">  469</span>&#160;`res-file` specifies the default base name of the results files to which tables are saved. If in any of the `DataOutputDescriptors` the `file` value is missing it will be set to this default value.</div><div class="line"><a name="l00470"></a><span class="lineno">  470</span>&#160;</div><div class="line"><a name="l00471"></a><span class="lineno">  471</span>&#160;#### --json-file</div><div class="line"><a name="l00472"></a><span class="lineno">  472</span>&#160;</div><div class="line"><a name="l00473"></a><span class="lineno">  473</span>&#160;`json-file` specifies the name of a json-file which contains the full information needed to customize the behavior of the internal-dpl-aod-writer. It can replace the other three options completely. Nevertheless, currently all options are supported ([see also discussion below](#redundancy)).</div><div class="line"><a name="l00474"></a><span class="lineno">  474</span>&#160;</div><div class="line"><a name="l00475"></a><span class="lineno">  475</span>&#160;An example file is shown in the highlighted field below. The relevant</div><div class="line"><a name="l00476"></a><span class="lineno">  476</span>&#160;information is contained in a json object `OutputDirector`. The</div><div class="line"><a name="l00477"></a><span class="lineno">  477</span>&#160;`OutputDirector` can include three different items:</div><div class="line"><a name="l00478"></a><span class="lineno">  478</span>&#160;</div><div class="line"><a name="l00479"></a><span class="lineno">  479</span>&#160;  1. `resfile` is a string and corresponds to the `res-file` command line option  </div><div class="line"><a name="l00480"></a><span class="lineno">  480</span>&#160;  2.`ntfmerge` is an integer and corresponds to the `ntfmerge` command line option  </div><div class="line"><a name="l00481"></a><span class="lineno">  481</span>&#160;  3.`OutputDescriptors` is an array of objects and corresponds to the `keep` command line option. The objects are equivalent to the `DataOuputDescriptors` of the `keep` option and are composed of 4 items which correspond to the 4 items of a `DataOuputDescriptor`.</div><div class="line"><a name="l00482"></a><span class="lineno">  482</span>&#160;  </div><div class="line"><a name="l00483"></a><span class="lineno">  483</span>&#160;     a. `table` is a string  </div><div class="line"><a name="l00484"></a><span class="lineno">  484</span>&#160;     b. `treename` is a string  </div><div class="line"><a name="l00485"></a><span class="lineno">  485</span>&#160;     c. `columns` is an array of strings  </div><div class="line"><a name="l00486"></a><span class="lineno">  486</span>&#160;     d. `filename` is a string  </div><div class="line"><a name="l00487"></a><span class="lineno">  487</span>&#160;  </div><div class="line"><a name="l00488"></a><span class="lineno">  488</span>&#160;  </div><div class="line"><a name="l00489"></a><span class="lineno">  489</span>&#160;`Example json file for the internal-dpl-aod-writer`</div><div class="line"><a name="l00490"></a><span class="lineno">  490</span>&#160;```csh</div><div class="line"><a name="l00491"></a><span class="lineno">  491</span>&#160;{</div><div class="line"><a name="l00492"></a><span class="lineno">  492</span>&#160;  &quot;OutputDirector&quot;: {</div><div class="line"><a name="l00493"></a><span class="lineno">  493</span>&#160;      &quot;resfile&quot;: &quot;defresults&quot;,</div><div class="line"><a name="l00494"></a><span class="lineno">  494</span>&#160;      &quot;ntfmerge&quot;: 10,</div><div class="line"><a name="l00495"></a><span class="lineno">  495</span>&#160;      &quot;OutputDescriptors&quot;: [</div><div class="line"><a name="l00496"></a><span class="lineno">  496</span>&#160;          {</div><div class="line"><a name="l00497"></a><span class="lineno">  497</span>&#160;            &quot;table&quot;: &quot;AOD/UNO/0&quot;,</div><div class="line"><a name="l00498"></a><span class="lineno">  498</span>&#160;            &quot;columns&quot;: [</div><div class="line"><a name="l00499"></a><span class="lineno">  499</span>&#160;              &quot;col1&quot;,</div><div class="line"><a name="l00500"></a><span class="lineno">  500</span>&#160;              &quot;col2&quot;</div><div class="line"><a name="l00501"></a><span class="lineno">  501</span>&#160;            ],</div><div class="line"><a name="l00502"></a><span class="lineno">  502</span>&#160;            &quot;treename&quot;: &quot;uno&quot;,</div><div class="line"><a name="l00503"></a><span class="lineno">  503</span>&#160;            &quot;filename&quot;: &quot;unoresults&quot;</div><div class="line"><a name="l00504"></a><span class="lineno">  504</span>&#160;          },</div><div class="line"><a name="l00505"></a><span class="lineno">  505</span>&#160;          {</div><div class="line"><a name="l00506"></a><span class="lineno">  506</span>&#160;            &quot;table&quot;: &quot;AOD/DUE/0&quot;,</div><div class="line"><a name="l00507"></a><span class="lineno">  507</span>&#160;            &quot;columns&quot;: [</div><div class="line"><a name="l00508"></a><span class="lineno">  508</span>&#160;              &quot;col3&quot;</div><div class="line"><a name="l00509"></a><span class="lineno">  509</span>&#160;            ],</div><div class="line"><a name="l00510"></a><span class="lineno">  510</span>&#160;            &quot;treename&quot;: &quot;due&quot;,</div><div class="line"><a name="l00511"></a><span class="lineno">  511</span>&#160;            &quot;filename&quot;: &quot;dueresults&quot;</div><div class="line"><a name="l00512"></a><span class="lineno">  512</span>&#160;          }</div><div class="line"><a name="l00513"></a><span class="lineno">  513</span>&#160;      ]</div><div class="line"><a name="l00514"></a><span class="lineno">  514</span>&#160;  }</div><div class="line"><a name="l00515"></a><span class="lineno">  515</span>&#160;}</div><div class="line"><a name="l00516"></a><span class="lineno">  516</span>&#160;```</div><div class="line"><a name="l00517"></a><span class="lineno">  517</span>&#160;&lt;a name=&quot;redundancy&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00518"></a><span class="lineno">  518</span>&#160;The information provided with the json file and the information which can be provided with</div><div class="line"><a name="l00519"></a><span class="lineno">  519</span>&#160;the other command line options is obviously redundant. Anyway, currently all options can</div><div class="line"><a name="l00520"></a><span class="lineno">  520</span>&#160;be used together. Practically the json-file - if provided - is read first. Then parameters are reset with values specified by other command line options. If any parameter value is still unset then its default value is used.</div><div class="line"><a name="l00521"></a><span class="lineno">  521</span>&#160;</div><div class="line"><a name="l00522"></a><span class="lineno">  522</span>&#160;This hierarchy of the options is summarized in the following table. The columns represent the command line options and the rows the parameters which can be set. The table elements specify the priority a given command line option has to set the value of a given parameter. The last column in the table is the default, which always has the lowest priority. The actual default value is the value shown between brackets.</div><div class="line"><a name="l00523"></a><span class="lineno">  523</span>&#160;</div><div class="line"><a name="l00524"></a><span class="lineno">  524</span>&#160;&lt;a name=&quot;priorities&quot;&gt;&lt;/a&gt;</div><div class="line"><a name="l00525"></a><span class="lineno">  525</span>&#160;</div><div class="line"><a name="l00526"></a><span class="lineno">  526</span>&#160;| parameter\option | keep | res-file | ntfmerge | json-file | default |</div><div class="line"><a name="l00527"></a><span class="lineno">  527</span>&#160;|--------------|:----:|:--------:|:--------:|----------:|:-------:|</div><div class="line"><a name="l00528"></a><span class="lineno">  528</span>&#160;| `default file name` | - | 1.    | -        | 2.        | 3. (AnalysisResults)|</div><div class="line"><a name="l00529"></a><span class="lineno">  529</span>&#160;| `ntfmerge`   | -    | -        |  1.      | 2.        | 3. (1)  |</div><div class="line"><a name="l00530"></a><span class="lineno">  530</span>&#160;| `tablename`  | 1.   | -        | -        | 2.        | -       |</div><div class="line"><a name="l00531"></a><span class="lineno">  531</span>&#160;| `tree`       | 1.   | -        | -        | 2.        | 3. (`tablename`) |</div><div class="line"><a name="l00532"></a><span class="lineno">  532</span>&#160;| `columns`    | 1.   | -        | -        | 2.        | 3. (all columns)     |</div><div class="line"><a name="l00533"></a><span class="lineno">  533</span>&#160;| `file`       | 1.   | 2.       | -        | 3.        | 4. (`default file name`)|</div><div class="line"><a name="l00534"></a><span class="lineno">  534</span>&#160;</div><div class="line"><a name="l00535"></a><span class="lineno">  535</span>&#160;</div><div class="line"><a name="l00536"></a><span class="lineno">  536</span>&#160;#### Valid example command line options</div><div class="line"><a name="l00537"></a><span class="lineno">  537</span>&#160;</div><div class="line"><a name="l00538"></a><span class="lineno">  538</span>&#160;```csh</div><div class="line"><a name="l00539"></a><span class="lineno">  539</span>&#160;--keep AOD/UNO/0</div><div class="line"><a name="l00540"></a><span class="lineno">  540</span>&#160; # save all columns of table &#39;UNO&#39; to TTree &#39;UNO&#39; in files &#39;AnalysisResults&#39;_x.root</div><div class="line"><a name="l00541"></a><span class="lineno">  541</span>&#160;  </div><div class="line"><a name="l00542"></a><span class="lineno">  542</span>&#160;--keep AOD/UNO/0::c2/c4:unoresults</div><div class="line"><a name="l00543"></a><span class="lineno">  543</span>&#160; # save columns &#39;c2&#39; and &#39;c4&#39; of table &#39;UNO&#39; to TTree &#39;UNO&#39; in files &#39;unoresults&#39;_x.root</div><div class="line"><a name="l00544"></a><span class="lineno">  544</span>&#160;</div><div class="line"><a name="l00545"></a><span class="lineno">  545</span>&#160;--res-file myskim --ntfmerge 50 --keep AOD/UNO/0:trsel1:c1/c2,AOD/DUE/0:trsel2:c6/c7/c8</div><div class="line"><a name="l00546"></a><span class="lineno">  546</span>&#160; # save columns &#39;c1&#39; and &#39;c2&#39; of table &#39;UNO&#39; to TTree &#39;trsel1&#39; in files &#39;myskim&#39;_x.root and</div><div class="line"><a name="l00547"></a><span class="lineno">  547</span>&#160; # save columns &#39;c6&#39;, &#39;c7&#39; and &#39;c8&#39; of table &#39;DUE&#39; to TTree &#39;trsel2&#39; in files &#39;myskim&#39;_x.root.</div><div class="line"><a name="l00548"></a><span class="lineno">  548</span>&#160; # Merge 50 time frames in each file.</div><div class="line"><a name="l00549"></a><span class="lineno">  549</span>&#160;</div><div class="line"><a name="l00550"></a><span class="lineno">  550</span>&#160;--json-file myconfig.json</div><div class="line"><a name="l00551"></a><span class="lineno">  551</span>&#160; # according to the contents of myconfig.json</div><div class="line"><a name="l00552"></a><span class="lineno">  552</span>&#160;```</div><div class="line"><a name="l00553"></a><span class="lineno">  553</span>&#160;</div><div class="line"><a name="l00554"></a><span class="lineno">  554</span>&#160;#### Limitations</div><div class="line"><a name="l00555"></a><span class="lineno">  555</span>&#160;</div><div class="line"><a name="l00556"></a><span class="lineno">  556</span>&#160;If in any case two `DataOuputDescriptors` are provided which have equal combinations of</div><div class="line"><a name="l00557"></a><span class="lineno">  557</span>&#160;the `tree` and `file` parameters then the processing is stopped! It is not possible to save</div><div class="line"><a name="l00558"></a><span class="lineno">  558</span>&#160;two trees with equal name to a given file.</div><div class="line"><a name="l00559"></a><span class="lineno">  559</span>&#160;</div><div class="line"><a name="l00560"></a><span class="lineno">  560</span>&#160;</div><div class="line"><a name="l00561"></a><span class="lineno">  561</span>&#160;### Reading tables from files</div><div class="line"><a name="l00562"></a><span class="lineno">  562</span>&#160;</div><div class="line"><a name="l00563"></a><span class="lineno">  563</span>&#160;The internal-dpl-aod-reader reads trees from root files and provides them as arrow tables to the requesting workflows. Its behavior is customized with the following command line options:</div><div class="line"><a name="l00564"></a><span class="lineno">  564</span>&#160;</div><div class="line"><a name="l00565"></a><span class="lineno">  565</span>&#160;* --aod-file</div><div class="line"><a name="l00566"></a><span class="lineno">  566</span>&#160;* --json-file</div><div class="line"><a name="l00567"></a><span class="lineno">  567</span>&#160;</div><div class="line"><a name="l00568"></a><span class="lineno">  568</span>&#160;#### --aod-file</div><div class="line"><a name="l00569"></a><span class="lineno">  569</span>&#160;</div><div class="line"><a name="l00570"></a><span class="lineno">  570</span>&#160;`aod-file` takes a string as option value, which either is the name of the input root file or, if starting with an `@`-character, is an ASCII-file which contains a list of input files. </div><div class="line"><a name="l00571"></a><span class="lineno">  571</span>&#160;</div><div class="line"><a name="l00572"></a><span class="lineno">  572</span>&#160;```csh</div><div class="line"><a name="l00573"></a><span class="lineno">  573</span>&#160;--aod-file AnalysisResults_0.root</div><div class="line"><a name="l00574"></a><span class="lineno">  574</span>&#160; # uses AnalysisResults_0.root as input file</div><div class="line"><a name="l00575"></a><span class="lineno">  575</span>&#160;</div><div class="line"><a name="l00576"></a><span class="lineno">  576</span>&#160;--aod-file @AnalysisResults.txt</div><div class="line"><a name="l00577"></a><span class="lineno">  577</span>&#160; # uses files listed in AnalysisResults.txt as input files</div><div class="line"><a name="l00578"></a><span class="lineno">  578</span>&#160;</div><div class="line"><a name="l00579"></a><span class="lineno">  579</span>&#160;```</div><div class="line"><a name="l00580"></a><span class="lineno">  580</span>&#160;</div><div class="line"><a name="l00581"></a><span class="lineno">  581</span>&#160;#### --json-file</div><div class="line"><a name="l00582"></a><span class="lineno">  582</span>&#160;</div><div class="line"><a name="l00583"></a><span class="lineno">  583</span>&#160;&#39;json-file&#39; is a string and specifies a json file, which contains the</div><div class="line"><a name="l00584"></a><span class="lineno">  584</span>&#160;customization information for the internal-dpl-aod-reader. An example file is</div><div class="line"><a name="l00585"></a><span class="lineno">  585</span>&#160;shown in the highlighted field below. The relevant information is contained in</div><div class="line"><a name="l00586"></a><span class="lineno">  586</span>&#160;a json object `InputDirector`. The `InputDirector` can include the following</div><div class="line"><a name="l00587"></a><span class="lineno">  587</span>&#160;three items:</div><div class="line"><a name="l00588"></a><span class="lineno">  588</span>&#160;</div><div class="line"><a name="l00589"></a><span class="lineno">  589</span>&#160;  1. `resfiles` is a string or an array of strings and corresponds to the `aod-file` command line option. As the `aod-file` option it can specify a single input file or, when the option value starts with a `@`-character, an ASCII file with a list of input files. In addition `resfiles` can be an array of strings, which contains a list of input files.</div><div class="line"><a name="l00590"></a><span class="lineno">  590</span>&#160;  2.`fileregex` is a regex string which is used to select the input files from the file list specified by `resfiles`.</div><div class="line"><a name="l00591"></a><span class="lineno">  591</span>&#160;  3.`InputDescriptors` is an array of objects, the so called `DataInputDescriptors`, which are composed of 4 items.</div><div class="line"><a name="l00592"></a><span class="lineno">  592</span>&#160;  </div><div class="line"><a name="l00593"></a><span class="lineno">  593</span>&#160;     a. `table` is a string and specifies the table to fill. The `table` needs to be provided in the format `AOD/tablename/0`, where `tablename` is the name of the table as defined in the workflow definition.  </div><div class="line"><a name="l00594"></a><span class="lineno">  594</span>&#160;     b. `treename` is a string and specifies the tree which is to be used to fill `table`  </div><div class="line"><a name="l00595"></a><span class="lineno">  595</span>&#160;     c. `resfiles` is either a string or an array of strings. It specifies a list of possible input files (see discussion of `resfiles` above).  </div><div class="line"><a name="l00596"></a><span class="lineno">  596</span>&#160;     d. `fileregex` is a regular expression string which is used to select the input files from the file list specified by `resfiles`  </div><div class="line"><a name="l00597"></a><span class="lineno">  597</span>&#160;</div><div class="line"><a name="l00598"></a><span class="lineno">  598</span>&#160;The information contained in a `DataInputDescriptor` instructs the internal-dpl-aod-reader to fill table `table` with the values from the tree `treename` in the files which are defined by `resfiles` and which names match the regex `fileregex`.</div><div class="line"><a name="l00599"></a><span class="lineno">  599</span>&#160;</div><div class="line"><a name="l00600"></a><span class="lineno">  600</span>&#160;Of the four items of a `DataInputDescriptor`, `table` is the only required information. If one of the other items is missing its value will be set as follows:</div><div class="line"><a name="l00601"></a><span class="lineno">  601</span>&#160;</div><div class="line"><a name="l00602"></a><span class="lineno">  602</span>&#160;  1. `treename` is set to `tablename` of the respective `table` item.  </div><div class="line"><a name="l00603"></a><span class="lineno">  603</span>&#160;  2. `resfiles` is set to `resfiles` of the `InputDirector` (1. item of the `InputDirector`). If that is missing, then the value of the `aod-file` option is used. If that is missing, then `AnalysisResults.root` is used.  </div><div class="line"><a name="l00604"></a><span class="lineno">  604</span>&#160;  3. `fileregex` is set to `fileregex` of the `InputDirector` (2. item of the `InputDirector`). If that is missing, then `.*` is used.</div><div class="line"><a name="l00605"></a><span class="lineno">  605</span>&#160;</div><div class="line"><a name="l00606"></a><span class="lineno">  606</span>&#160;</div><div class="line"><a name="l00607"></a><span class="lineno">  607</span>&#160;`Example json file for the internal-dpl-aod-reader`</div><div class="line"><a name="l00608"></a><span class="lineno">  608</span>&#160;```csh</div><div class="line"><a name="l00609"></a><span class="lineno">  609</span>&#160;{</div><div class="line"><a name="l00610"></a><span class="lineno">  610</span>&#160;  &quot;InputDirector&quot;: {</div><div class="line"><a name="l00611"></a><span class="lineno">  611</span>&#160;    &quot;resfiles&quot;: &quot;@resfiles.txt&quot;,</div><div class="line"><a name="l00612"></a><span class="lineno">  612</span>&#160;    &quot;fileregex&quot;: &quot;.*&quot;,</div><div class="line"><a name="l00613"></a><span class="lineno">  613</span>&#160;    &quot;InputDescriptors&quot;: [</div><div class="line"><a name="l00614"></a><span class="lineno">  614</span>&#160;      {</div><div class="line"><a name="l00615"></a><span class="lineno">  615</span>&#160;        &quot;table&quot;: &quot;AOD/COLLISION/0&quot;,</div><div class="line"><a name="l00616"></a><span class="lineno">  616</span>&#160;        &quot;treename&quot;: &quot;uno&quot;,</div><div class="line"><a name="l00617"></a><span class="lineno">  617</span>&#160;        &quot;resfiles&quot;: [</div><div class="line"><a name="l00618"></a><span class="lineno">  618</span>&#160;          &quot;unoresults_1.root&quot;,</div><div class="line"><a name="l00619"></a><span class="lineno">  619</span>&#160;          &quot;unoresults_2.root&quot;,</div><div class="line"><a name="l00620"></a><span class="lineno">  620</span>&#160;          &quot;unoresults_3.root&quot;,</div><div class="line"><a name="l00621"></a><span class="lineno">  621</span>&#160;          &quot;unoresults_4.root&quot;</div><div class="line"><a name="l00622"></a><span class="lineno">  622</span>&#160;        ]</div><div class="line"><a name="l00623"></a><span class="lineno">  623</span>&#160;      },</div><div class="line"><a name="l00624"></a><span class="lineno">  624</span>&#160;      {</div><div class="line"><a name="l00625"></a><span class="lineno">  625</span>&#160;        &quot;table&quot;: &quot;AOD/DUE/0&quot;,</div><div class="line"><a name="l00626"></a><span class="lineno">  626</span>&#160;        &quot;treename&quot;: &quot;due&quot;,</div><div class="line"><a name="l00627"></a><span class="lineno">  627</span>&#160;        &quot;resfiles&quot;: &quot;@dueresults.txt&quot;,</div><div class="line"><a name="l00628"></a><span class="lineno">  628</span>&#160;        &quot;fileregex&quot;: &quot;(dueresults)(.*)&quot;</div><div class="line"><a name="l00629"></a><span class="lineno">  629</span>&#160;      },</div><div class="line"><a name="l00630"></a><span class="lineno">  630</span>&#160;      {</div><div class="line"><a name="l00631"></a><span class="lineno">  631</span>&#160;        &quot;table&quot;: &quot;AOD/TRE/0&quot;,</div><div class="line"><a name="l00632"></a><span class="lineno">  632</span>&#160;        &quot;treename&quot;: &quot;tre&quot;</div><div class="line"><a name="l00633"></a><span class="lineno">  633</span>&#160;      }</div><div class="line"><a name="l00634"></a><span class="lineno">  634</span>&#160;    ]</div><div class="line"><a name="l00635"></a><span class="lineno">  635</span>&#160;  }</div><div class="line"><a name="l00636"></a><span class="lineno">  636</span>&#160;```</div><div class="line"><a name="l00637"></a><span class="lineno">  637</span>&#160;</div><div class="line"><a name="l00638"></a><span class="lineno">  638</span>&#160;When the internal-dpl-aod-reader receives the request to fill a given table `tablename` it searches in the provided `InputDirector` for the corresponding `InputDescriptor` and proceeds as defined there. However, if there is no corresponding `InputDescriptor` it falls back to the information provided by the `resfiles` and `fileregex` options of the `InputDirector` and uses the `tablename` as `treename`.</div><div class="line"><a name="l00639"></a><span class="lineno">  639</span>&#160;</div><div class="line"><a name="l00640"></a><span class="lineno">  640</span>&#160;#### Some practical comments</div><div class="line"><a name="l00641"></a><span class="lineno">  641</span>&#160;</div><div class="line"><a name="l00642"></a><span class="lineno">  642</span>&#160;The `json-file` option allows to setup the reading of tables in a rather</div><div class="line"><a name="l00643"></a><span class="lineno">  643</span>&#160;flexible way. Here a few presumably practical cases are discussed:</div><div class="line"><a name="l00644"></a><span class="lineno">  644</span>&#160;</div><div class="line"><a name="l00645"></a><span class="lineno">  645</span>&#160;  1. Let&#39;s assume a case where data from tables `tableA` and `tableB` need to</div><div class="line"><a name="l00646"></a><span class="lineno">  646</span>&#160;be processed together. Table `tableA` was previously saved as tree `tableA` to</div><div class="line"><a name="l00647"></a><span class="lineno">  647</span>&#160;files `tableAResults_x.root`, where `x` is a number and `tableB` was saved as</div><div class="line"><a name="l00648"></a><span class="lineno">  648</span>&#160;tree `tableB` to `tableBResults_x.root`. The following json-file could be used</div><div class="line"><a name="l00649"></a><span class="lineno">  649</span>&#160;to read these tables:</div><div class="line"><a name="l00650"></a><span class="lineno">  650</span>&#160;</div><div class="line"><a name="l00651"></a><span class="lineno">  651</span>&#160;```csh</div><div class="line"><a name="l00652"></a><span class="lineno">  652</span>&#160;{</div><div class="line"><a name="l00653"></a><span class="lineno">  653</span>&#160;  # file resfiles.txt lists all tableAResults_x.root and tableBResults_x.root files.</div><div class="line"><a name="l00654"></a><span class="lineno">  654</span>&#160;</div><div class="line"><a name="l00655"></a><span class="lineno">  655</span>&#160;  &quot;InputDirector&quot;: {</div><div class="line"><a name="l00656"></a><span class="lineno">  656</span>&#160;    &quot;resfiles&quot;: &quot;@resfiles.txt&quot;,</div><div class="line"><a name="l00657"></a><span class="lineno">  657</span>&#160;    &quot;InputDescriptors&quot;: [</div><div class="line"><a name="l00658"></a><span class="lineno">  658</span>&#160;      {</div><div class="line"><a name="l00659"></a><span class="lineno">  659</span>&#160;        &quot;table&quot;: &quot;AOD/tableA/0&quot;,</div><div class="line"><a name="l00660"></a><span class="lineno">  660</span>&#160;        &quot;fileregex&quot;: &quot;(tableAResult)(.*)&quot;</div><div class="line"><a name="l00661"></a><span class="lineno">  661</span>&#160;      },</div><div class="line"><a name="l00662"></a><span class="lineno">  662</span>&#160;      {</div><div class="line"><a name="l00663"></a><span class="lineno">  663</span>&#160;        &quot;table&quot;: &quot;AOD/tableB/0&quot;,</div><div class="line"><a name="l00664"></a><span class="lineno">  664</span>&#160;        &quot;fileregex&quot;: &quot;(tableBResult)(.*)&quot;</div><div class="line"><a name="l00665"></a><span class="lineno">  665</span>&#160;      }</div><div class="line"><a name="l00666"></a><span class="lineno">  666</span>&#160;    ]</div><div class="line"><a name="l00667"></a><span class="lineno">  667</span>&#160;  }</div><div class="line"><a name="l00668"></a><span class="lineno">  668</span>&#160;```</div><div class="line"><a name="l00669"></a><span class="lineno">  669</span>&#160;</div><div class="line"><a name="l00670"></a><span class="lineno">  670</span>&#160;  2. In this case several tables need to be provided. All tables can be read from files `tableResult_x.root`, except for one table, namely `tableA`, which is saved as tree `treeA` in files `tableAResult_x.root`.</div><div class="line"><a name="l00671"></a><span class="lineno">  671</span>&#160;  </div><div class="line"><a name="l00672"></a><span class="lineno">  672</span>&#160;```csh</div><div class="line"><a name="l00673"></a><span class="lineno">  673</span>&#160;  # file resfiles.txt lists all tableResults_x.root and tableAResults_x.root files.</div><div class="line"><a name="l00674"></a><span class="lineno">  674</span>&#160;</div><div class="line"><a name="l00675"></a><span class="lineno">  675</span>&#160;  &quot;InputDirector&quot;: {</div><div class="line"><a name="l00676"></a><span class="lineno">  676</span>&#160;    &quot;resfiles&quot;: &quot;@resfiles.txt&quot;,</div><div class="line"><a name="l00677"></a><span class="lineno">  677</span>&#160;    &quot;fileregex&quot;: &quot;(tableResult)(.*)&quot;</div><div class="line"><a name="l00678"></a><span class="lineno">  678</span>&#160;    &quot;InputDescriptors&quot;: [</div><div class="line"><a name="l00679"></a><span class="lineno">  679</span>&#160;      {</div><div class="line"><a name="l00680"></a><span class="lineno">  680</span>&#160;        &quot;table&quot;: &quot;AOD/tableA/0&quot;,</div><div class="line"><a name="l00681"></a><span class="lineno">  681</span>&#160;        &quot;treename&quot;: &quot;treeA&quot;,</div><div class="line"><a name="l00682"></a><span class="lineno">  682</span>&#160;        &quot;fileregex&quot;: &quot;(tableAResult)(.*)&quot;</div><div class="line"><a name="l00683"></a><span class="lineno">  683</span>&#160;      }</div><div class="line"><a name="l00684"></a><span class="lineno">  684</span>&#160;    ]</div><div class="line"><a name="l00685"></a><span class="lineno">  685</span>&#160;  }</div><div class="line"><a name="l00686"></a><span class="lineno">  686</span>&#160;```</div><div class="line"><a name="l00687"></a><span class="lineno">  687</span>&#160;  </div><div class="line"><a name="l00688"></a><span class="lineno">  688</span>&#160;</div><div class="line"><a name="l00689"></a><span class="lineno">  689</span>&#160;#### Limitations</div><div class="line"><a name="l00690"></a><span class="lineno">  690</span>&#160;</div><div class="line"><a name="l00691"></a><span class="lineno">  691</span>&#160;  1. It is required that all `InputDescriptors` have the same number of selected input files. This is internally checked and the processing is stopped if it turns out that this is not the case.</div><div class="line"><a name="l00692"></a><span class="lineno">  692</span>&#160;  2. The internal-dpl-aod-reader loops over the selected input files in the order as they are listed. It is the duty of the user to make sure that the order is correct and that the order in the file lists</div><div class="line"><a name="l00693"></a><span class="lineno">  693</span>&#160;of the various `InputDescriptors` are corresponding to each other.</div><div class="line"><a name="l00694"></a><span class="lineno">  694</span>&#160;  3. The regular expression `fileregex` is evaluated with the c++ Regular expressions library. Thus check there for the proper syntax of regexes.</div><div class="line"><a name="l00695"></a><span class="lineno">  695</span>&#160;  </div><div class="line"><a name="l00696"></a><span class="lineno">  696</span>&#160;</div><div class="line"><a name="l00697"></a><span class="lineno">  697</span>&#160;### Possible ideas</div><div class="line"><a name="l00698"></a><span class="lineno">  698</span>&#160;</div><div class="line"><a name="l00699"></a><span class="lineno">  699</span>&#160;We could add a template `&lt;typename C...&gt; reshuffle()` method to the Table class which allows you to reduce the number of columns or attach new dynamic columns. A template wrapper could</div><div class="line"><a name="l00700"></a><span class="lineno">  700</span>&#160;even be used to specify if a given dynamic column should be precalculated (or not). This would come handy to optimize the creation of a RowView, which could bind only the required (dynamic) columns. E.g.:</div><div class="line"><a name="l00701"></a><span class="lineno">  701</span>&#160;</div><div class="line"><a name="l00702"></a><span class="lineno">  702</span>&#160;```cpp</div><div class="line"><a name="l00703"></a><span class="lineno">  703</span>&#160;for (auto twoD : points.reshuffle&lt;point::X, point::Y, Cached&lt;point::R&gt;&gt;()) {</div><div class="line"><a name="l00704"></a><span class="lineno">  704</span>&#160;...</div><div class="line"><a name="l00705"></a><span class="lineno">  705</span>&#160;} </div><div class="line"><a name="l00706"></a><span class="lineno">  706</span>&#160;```</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../da/d3c/ANALYSIS_8md.html">ANALYSIS.md</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:32 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
