<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: TPC workflow</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dd/dac/refTPCworkflow.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">TPC workflow </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>DPL workflows for the TPC</h1>
<h2>TPC reconstruction workflow</h2>
<p>The TPC reconstruction workflow starts from the TPC digits, the <em>clusterer</em> reconstructs clusters in the <a href="../../../../../DataFormats/Detectors/TPC/include/DataFormatsTPC/ClusterHardware.h">ClusterHardware</a> format. The clusters are directly written in the <em>RAW page</em> format. The raw data are passed onto the <em>decoder</em> providing the <a href="../../../../../DataFormats/Detectors/TPC/include/DataFormatsTPC/ClusterNative.h">TPC native cluster</a> format to the <em>tracker</em>.</p>
<p>Note: The format of the raw pages is preliminary and does not reflect what is currently implemented in the CRU.</p>
<p>The workflow consists of the following DPL processors:</p>
<ul>
<li><code>tpc-digit-reader</code> -&gt; using tool <a href="../../../../../Framework/Utils/include/Utils/RootTreeReader.h">o2::framework::RootTreeReader</a></li>
<li><code>tpc-clusterer</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/HwClusterer.h">o2::tpc::HwClusterer</a></li>
<li><code>tpc-cluster-decoder</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/HardwareClusterDecoder.h">o2::tpc::HardwareClusterDecoder</a></li>
<li><code>tpc-tracker</code> -&gt; interfaces <a href="../../../reconstruction/include/TPCReconstruction/GPUCATracking.h">o2::tpc::GPUCATracking</a></li>
<li><code>tpc-track-writer</code> -&gt; implements simple writing to <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
</ul>
<p>Depending on the input and output types the default workflow is extended by the following readers and writers:</p><ul>
<li><code>tpc-raw-cluster-writer</code> writes the binary raw format data to binary branches in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-raw-cluster-reader</code> reads data from binary branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-cluster-writer</code> writes the binary native cluster data to binary branches in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
<li><code>tpc-cluster-reader</code> reads data from binary branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</li>
</ul>
<p>MC labels are passed through the workflow along with the data objects and also written together with the output at the configured stages (see output types).</p>
<h3>Input data</h3>
<p>The input can be created by running the simulation (<code>o2sim</code>) and the digitizer workflow (<code>digitizer-workflow</code>). The digitizer workflow produces the file <code>tpcdigits.root</code> by default, data is stored in separated branches for all sectors.</p>
<p>The workflow can be run starting from digits, raw clusters, or (native) clusters, or directly attached to the <code>o2-sim-digitizer-workflow</code>, see comment on inputs types below.</p>
<h3>Quickstart running the reconstruction workflow</h3>
<p>The workflow is implemented in the <code>o2-tpc-reco-workflow</code> executable.</p>
<p>Display all options </p><div class="fragment"><div class="line">o2-tpc-reco-workflow --help</div></div><!-- fragment --><p>Important options for the <code>tpc-digit-reader</code> as initial publisher </p><div class="fragment"><div class="line">--infile arg                          Name of the input file</div><div class="line">--treename arg (=o2sim)               Name of the input tree</div><div class="line">--digitbranch arg (=TPCDigit)         Digit branch</div><div class="line">--mcbranch arg (=TPCDigitMCTruth)     MC label branch</div><div class="line">--nevents                             Number of events</div></div><!-- fragment --><p>The <code>tpc-raw-cluster-reader</code> uses the same options except the branch name configuration &ndash;databranch arg (==TPCClusterHw) RAW Cluster branch &ndash;mcbranch arg (==TPCClusterHwMCTruth) MC label branch</p>
<p>Options for the <code>tpc-track-writer</code> process </p><div class="fragment"><div class="line">--outfile arg (=tpctracks.root)               Name of the output file</div><div class="line">--treename arg (=tpcrec)                      Name of tree</div><div class="line">--nevents arg (=-1)                           Number of events to execute</div><div class="line">--terminate arg (=process)                    Terminate the &#39;process&#39; or &#39;workflow&#39;</div><div class="line">--track-branch-name arg (=TPCTracks)          configurable branch name for the tracks</div><div class="line">--trackmc-branch-name arg (=TPCTracksMCTruth) configurable branch name for the MC labels</div></div><!-- fragment --><p>Examples: </p><div class="fragment"><div class="line">o2-tpc-reco-workflow --infile tpcdigits.root --tpc-sectors 0-17 --tracker-options &quot;cont refX=83 bz=-5.0068597793&quot;</div></div><!-- fragment --><div class="fragment"><div class="line">o2-tpc-reco-workflow --infile tpcdigits.root --tpc-sectors 0-17 --disable-mc 1 --tracker-options &quot;cont refX=83 bz=-5.0068597793&quot;</div></div><!-- fragment --><p>### Global workflow options: </p><div class="fragment"><div class="line">--input-type arg (=digits)            digitizer, digits, raw, clusters</div><div class="line">--output-type arg (=tracks)           digits, raw, clusters, tracks</div><div class="line">--disable-mc arg (=0)                 disable sending of MC information</div><div class="line">--tpc-lanes arg (=1)                  number of parallel lanes up to the tracker</div><div class="line">--tpc-sectors arg (=0-35)             TPC sector range, e.g. 5-7,8,9</div></div><!-- fragment --><h4>Input Type</h4>
<p>Input type <code>digitizer</code> will create the clusterers with dangling input, this is used to connect the reconstruction workflow directly to the digitizer workflow.</p>
<p>All other input types will create a publisher process reading data from branches of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file. File and branch names are configurable. The MC labels are always read from a parallel branch, the sequence of data and MC objects is assumed to be identical.</p>
<h4>Output Type</h4>
<p>The output type selects up to which final product the workflow is executed. Multiple outputs are supported in order to write data at intermediate steps, e.g. </p><div class="fragment"><div class="line">--output-type raw,tracks</div></div><!-- fragment --><p>MC label data are stored in corresponding branches per sector. The sequence of MC objects must match the sequence of data objects.</p>
<p>By default, all data is written to <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> files, even the data in binary format like the raw data and cluster data. This allows to record multiple sets (i.e. timeframes/events) in one file alongside with the MC labels.</p>
<h4>Parallel processing</h4>
<p>Parallel processing is controlled by the option <code>--tpc-lanes n</code>. The digit reader will fan out to n processing lanes, each with clusterer, and decoder. The tracker will fan in from multiple parallel lanes. For each sector, a dedicated DPL data channel is created. The channels are distributed among the lanes. The default configuration processes sector data belonging together in the same time slice, but in earlier implementations the sector data was distributed among multiple time slices (thus abusing the DPL time slice concept). The tracker spec implements optional buffering of the input data, if the set is not complete within one invocation of the processing function.</p>
<h4>TPC sector selection</h4>
<p>By default, all TPC sectors are processed by the workflow, option <code>--tpc-sectors</code> reduces this to a subset.</p>
<h3>Processor options</h3>
<h4>TPC CA tracker</h4>
<p>The <a href="../../src/CATrackerSpec.cxx">tracker spec</a> interfaces the <a href="../../../reconstruction/include/TPCReconstruction/GPUCATracking.h">o2::tpc::GPUCATracking</a> worker class which can be initialized using an option string. The processor spec defines the option <code>--tracker-option</code>. Currently, the tracker should be run with options: </p><div class="fragment"><div class="line">--tracker-option &quot;refX=83 cont&quot;</div></div><!-- fragment --><p>The most important tracker options are: </p><div class="fragment"><div class="line">cont    activation of continuous mode</div><div class="line">refX=   reference x coordinate, tracker tries to propagate all track to the reference</div><div class="line">bz=     magnetic field</div></div><!-- fragment --><h3>Current limitations/TODO</h3>
<ul>
<li>the propagation of MC labels goes together with multiple rearrangements and thus copy</li>
<li>raw pages are using RawDataHeader version 2 with 4 64bit words, need to be converted to version 4 also the CRU will pad all words, RawDataHeader and data words to 128 bits, this is not yet reflected in the produced raw data</li>
<li>implement configuration from the GRP</li>
</ul>
<h2>Open questions</h2>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d0/d2f/refDetectors.html">Module &#39;Detectors&#39;</a></li><li class="navelem"><a class="el" href="../../d5/d4d/refDetectorsTPC.html">TPC</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:40 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
