<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Utils</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/d10/refFrameworkUtils.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Utils </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h2>DPL Utilities</h2>
<h3>Raw proxy</h3>
<p>Executable: </p><div class="fragment"><div class="line">o2-dpl-raw-proxy</div></div><!-- fragment --><p><a class="el" href="../../d2/d88/classA.html">A</a> proxy workflow to connect to a channel from DataDistribution. The incoming data is supposed to follow the O2 data model with header-payload pair messages. The header message must contain <code>DataHeader</code> and the internal DPL <code>DataProcessingHeader</code>. Only data which match the configured outputs will be forwarded.</p>
<p>Since payload can be split into several messages, the proxy will create a new message to merge all parts belonging to one payload entity.</p>
<p>#### Usage: <code>o2-dpl-raw-proxy</code> </p><div class="fragment"><div class="line">o2-dpl-raw-proxy --dataspec &quot;0:FLP/RAWDATA&quot; --channel-config &quot;name=readout-proxy,type=pair,method=bind,address=ipc:///tmp/stf-builder-dpl-pipe-0,transport=shmem,rateLogging=1&quot;</div></div><!-- fragment --><p>Options: </p><div class="fragment"><div class="line">--dataspec arg (=A:FLP/RAWDATA;B:FLP/DISTSUBTIMEFRAME/0)</div><div class="line">                                      selection string for the data to be </div><div class="line">                                      proxied</div><div class="line">--throwOnUnmatched                    throw if unmatched input data is found</div></div><!-- fragment --><p>Data is selected by using a configuration string of the format <code>tag1:origin/description/subspec;tag2:...</code>, the tags are arbitrary and only for internal reasons and are ignored. Example: </p><div class="fragment"><div class="line">--dataspec &#39;A:FLP/RAWDATA;B:FLP/DISTSUBTIMEFRAME/0&#39;</div></div><!-- fragment --><p>The input channel has name <code>readout-proxy</code> and is configured with option <code>--channel-config</code>.</p>
<p>By default, data blocks not matching the configured filter/output spec will be silently ignored. Use <code>--throwOnUnmatched</code> to apply a strict checking in order to indicate unmatched data.</p>
<h4>Connection to workflows</h4>
<p>The proxy workflow only defines the proxy process, workflows can be combined by piping them together om the command line </p><div class="fragment"><div class="line">o2-dpl-raw-proxy --dataspec &quot;0:FLP/RAWDATA&quot; --channel-config &quot;...&quot; | the-subscribing-workflow</div></div><!-- fragment --><h4>TODO:</h4>
<ul>
<li>stress test with data not following the O2 data model</li>
<li>forwarding of shared memory messages</li>
<li>vector handling of split payload parts in DPL</li>
<li>make the channel config more convenient, do not require the full string and use defaults, e.g. for the name (which can not be changed anyhow)</li>
<li>check if the channel config string can be parsed omitting tags, right now this is only possible for the first entry</li>
</ul>
<h3>RAW parser</h3>
<p>Class RawParser implements a parser for O2 raw data which is organized in pages of a fixed size, each page starts with the RAWDataHeader. The page size may actually be smaller than the maximum size, depending on the header fields.</p>
<p>The parser class works on a contiguous sequence of raw pages in a raw buffer. Multiple versions of RAWDataHeader are supported transparently and selected depending on the version field of the header.</p>
<p>#### Usage: <code>RawParser</code> </p><div class="fragment"><div class="line">// option 1: parse method</div><div class="line">RawParser parser(buffer, size);</div><div class="line">auto processor = [&amp;count](auto data, size_t length) {</div><div class="line">  std::cout &lt;&lt; &quot;Processing block of length &quot; &lt;&lt; length &lt;&lt; std::endl;</div><div class="line">};</div><div class="line">parser.parse(processor);</div><div class="line"></div><div class="line">// option 2: iterator</div><div class="line">RawParser parser(buffer, size);</div><div class="line">for (auto it = parser.begin(), end = parser.end(); it != end; ++it, ++count) {</div><div class="line">  std::cout &lt;&lt; &quot;Iterating block of length &quot; &lt;&lt; it.length() &lt;&lt; std::endl;</div><div class="line">  auto dataptr = it.data();</div><div class="line">}</div></div><!-- fragment --><h3>DPL raw parser class</h3>
<p>Utility class to transparently iterate over raw pages distributed over multiple messsages on multiple routes.</p>
<p><a class="el" href="../../d2/d88/classA.html">A</a> DPL processor might receive raw pages accumulated on three levels: 1) the DPL processor has one or more input route(s) 2) multiple parts per input route (split payloads or multiple input specs matching the same route spec 3) variable number of raw pages in one payload</p>
<p>Internally, class RawParser is used to access raw pages withon one payload message and dynamically adopt to RAWDataHeader version.</p>
<p>The parser provides an iterator interface to loop over raw pages, starting at the first raw page of the first payload at the first route and going to the next route when all payloads are processed. The iterator element is RawDataHeaderInfo containing just the two least significant bytes of the RDH where we have the version and header size.</p>
<p>The iterator object provides methods to access the concrete RDH, the raw buffer, the payload, etc.</p>
<h4>Usage</h4>
<p>The parser needs an object of DPL InputRecord provided by the ProcessingContext.</p>
<div class="fragment"><div class="line">auto&amp; inputs = context.inputs();</div><div class="line">DPLRawParser parser(inputs);</div><div class="line">for (auto it = parser.begin(), end = parser.end(); it != end; ++it) {</div><div class="line">  // retrieving RDH v4</div><div class="line">  auto const* rdh = it.get_if&lt;o2::header::RAWDataHeaderV4&gt;();</div><div class="line">  // retrieving the raw pointer of the page</div><div class="line">  auto const* raw = it.raw();</div><div class="line">  // retrieving payload pointer of the page</div><div class="line">  auto const* payload = it.data();</div><div class="line">  // size of payload</div><div class="line">  size_t payloadSize = it.size();</div><div class="line">  // offset of payload in the raw page</div><div class="line">  size_t offset = it.offset();</div><div class="line">}</div></div><!-- fragment --><p><a class="el" href="../../d2/d88/classA.html">A</a> list of InputSpec definiions can be provided to filter the incoming messages by the DataHeader. </p><div class="fragment"><div class="line">DPLRawParser parser(inputs, o2::framework::select(&quot;A:ITS/RAWDATA&quot;));</div></div><!-- fragment --><p> Note: <code>select</code> is a helper function of WorkflowSpec.h which builds InputSpecs from a string.</p>
<p>The iterator implements stream output operator to print out RDH fields in a table, a specific format wrapper prints RDH info and table header, e.g. for </p><div class="fragment"><div class="line">std::cout &lt;&lt; DPLRawParser::RDHInfo(it) &lt;&lt; std::endl;</div><div class="line">std::cout &lt;&lt; it &lt;&lt; std::endl;</div></div><!-- fragment --><p>output can look like </p><div class="fragment"><div class="line">DET/RAWDATA/196616   1 part(s) payload size 8192</div><div class="line">RDH v4</div><div class="line">  PkC pCnt  fId  Mem CRU  EP LID    HBOrbit  HBBC  s</div><div class="line">   92    1 4844   64   3   0   8 1013162567     0  1</div></div><!-- fragment --><h4>Workflow example</h4>
<p>Executable: </p><div class="fragment"><div class="line">o2-dpl-raw-parser</div></div><!-- fragment --><p>Parser workflow defines one process with configurable inputs and a loop over the input data which sets up the RawParser class and executes some basic parsing and statistic printout.</p>
<p>#### Usage: <code>o2-dpl-raw-parser</code> </p><div class="fragment"><div class="line">o2-dpl-raw-parser --input-spec &quot;A:FLP/RAWDATA&quot;</div></div><!-- fragment --><p>Options: </p><div class="fragment"><div class="line">--input-spec arg (=A:FLP/RAWDATA)</div><div class="line">--log-level n    0: off; 1: medium; 2: high  </div></div><!-- fragment --><p>In medium log level, the RDH version and the table header for the RDH field are printed for each new data description, in level high this will be done also for all parts with the same data description. The RDH fields are printed in a table per raw page.</p>
<p>The workflow can be connected to the o2-dpl-raw-proxy workflow using pipe on command line.</p>
<h3>DPL output proxy</h3>
<p>Executable: </p><div class="fragment"><div class="line">o2-dpl-output-proxy</div></div><!-- fragment --><p><a class="el" href="../../d2/d88/classA.html">A</a> proxy workflow to connect to workflow output and forward it to out-of-band channels, meaning channels outside DPL.</p>
<p>#### Usage: <code>o2-dpl-output-proxy</code> </p><div class="fragment"><div class="line">o2-dpl-output-proxy --dataspec &quot;channelname:TPC/TRACKS&quot; --channel-config name=channelname,...</div></div><!-- fragment --><p>Output channel(s): to be defined with the FairMQ device channel configuration option, e.g. </p><div class="fragment"><div class="line">--channel-config name=downstream,type=push,method=bind,address=icp://localhost_4200,rateLogging=60,transport=shmem</div></div><!-- fragment --><p>Input to the proxy is defined by the DPL data spec syntax </p><div class="fragment"><div class="line">binding1:origin1/description1/subspecification1;binding2:origin2/descritption2;...</div></div><!-- fragment --><p> The binding label can be used internally to access the input, here it is used to match to a configured output channel. That binding can be the same for multiple data specs.</p>
<p>Options: </p><div class="fragment"><div class="line">--dataspec       specs           Data specs of data to be proxied</div><div class="line">--channel-config config          FairMQ device channel configuration for the output channel</div><div class="line">--proxy-name     name            name of the proxy processor, used also as default output channel name</div><div class="line">--default-transport arg (=shmem) default transport: shmem, zeromq</div><div class="line">--default-port arg (=4200)       default port number</div></div><!-- fragment --><p> Note: the 'default-*' options are only for building the the default of the channel configuration. The default channel name is build from the name of the proxy device. Having a default channel configuration allows to skip the '&ndash;channel-config' option on the command line.</p>
<h3><a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> Tree reader and writer</h3>
<p>documentation to be filled </p>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d8/d3a/refFramework.html">Module &#39;Framework&#39;</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:40 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
