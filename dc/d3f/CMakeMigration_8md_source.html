<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: CMakeMigration.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('dc/d3f/CMakeMigration_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">CMakeMigration.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../dc/d3f/CMakeMigration_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;!-- doxy</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\page refdocModernCMakeMigration Modern CMake Migration</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/doxy --&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;# Migration to &quot;Modern&quot; CMake</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## Big picture</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The driving force is to abandon the whole bucket system that proved itself a great way to hide genuine dependency issues we&#39;re having in our build system.</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;To do so the main idea is to migrate our CMake usage to latest practices recommended by the CMake community.</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;Details can be found in many online locations in [blog post](https://pabloariasal.github.io/2018/02/19/its-time-to-do-cmake-right/), [video](https://www.youtube.com/watch?v=bsXLMQ6WgIk), or [book](https://crascit.com/professional-cmake/) form, but the core concept is to base everything on **targets** and forego as much as possible the usage of variables and/or directory specific functions.</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;Also, since our CMakeLists.txt that were first written a few years back, more third-party libraries have embraced the new CMake ways of working and as such provide reasonably good `XXXConfig.cmake` files that are used when using `find_package(XXX)`. We should use them instead of cooking complicated `FindXXX.cmake` as much as we can.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;Targets are normally created with CMake-provided functions like `add_library`, `add_executable` and characterized with functions like `target_include_directories`, `target_link_libraries`, etc...</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;We pondered for a long time whether we should simply stick to those native functions for our builds. But that would mean quite a bit of repetitive pieces of code in all our CMakeLists.txt. Plus it would make enforcing some conventions harder. So we decided (like in the previous incarnation of our build system) to use our own functions instead.</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;Compared to the previous system though, we tried :</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;- to use names (of the functions and their parameters) closely matching those of the original CMake ones, so people that already know CMake are less confused</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;- to use only functions instead of macros (unless required), so the parameters do not leak into parent scope</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;- to forego (almost) completely the usage of custom variables (variables are not bad practice per se, but most of our CMakeLists.txt can be written without any)</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;## Custom CMake functions</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;All our CMake functions are defined in the [cmake](../cmake) directory. Each file there defines one function. The filename is [UpperCamelCase](https://en.wikipedia.org/wiki/Camel_case) while the function name is [snake_case](https://en.wikipedia.org/wiki/Snake_case) (CMake function names are case insensitive but the modern convention is to have them all lower case). So for instance `o2_add_executable` is defined in `cmake/O2AddExecutable.cmake`. Each function is documented in its corresponding `.cmake` file.</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;The main defined functions are currently :</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;- [o2_add_executable](../cmake/O2AddExecutable.cmake)</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;- [o2_add_library](../cmake/O2AddLibrary.cmake)</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;- [o2_add_header_only_library](../cmake/O2AddHeaderOnleLibrary.cmake)</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;- [o2_add_test](../cmake/O2AddTest.cmake)</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;- [o2_add_test_wrapper](../cmake/O2AddTestWrapper.cmake)</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;- [o2_target_root_dictionary](../cmake/O2TargetRootDictionary.cmake)</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;All the `o2_` functions above take as first (unnamed) parameter the _basename_ of a target. In order to prepare for the packaging step, the actual target name is _not_ the same as this _basename_. The target naming scheme is handled by the `o2_name_target` function. But in most cases the developpers do not need to know this final name, just that their target should be referenced as `basename` when they are used as first parameter of the `o2_xxx` functions or as `O2::basename` when used as dependencies.</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;## Migration plan</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;The idea is to go in steps.</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;1. rewrite all our main CMakeLists.txt to get a working build, but without taking care of the more difficult or less critical parts, like a) GPU stuff (critical and difficult) b) testing of Root macros (difficult) c) getting a proper O2Config.cmake produced (aka packaging). This first step is like a proof-of-concept, but almost full scale. Discuss the implementation choices at this stage.</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;2. add GPU/HIP/OpenCL stuff</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;3. add creation of O2Config.cmake</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;4. add Root macro testing</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;5. polish and fix the remaining inconsistencies (e.g. test labelling, etc...)</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;## Step 1</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;In this step the idea is to limit ourselves to change only `CMakeLists.txt` and `*.cmake` files and not the source code (unless absolutely necessary). The top [CMakeLists.txt](../CMakeLists.txt) was rewritten from scratch and is composed of different parts :</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;- preamble: basic project definition, cmake version requirement, ctest inclusion</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;- project wide setup: cxx checks, build options, output paths, rpath settings</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;- external dependencices: all the find_package calls</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;- definition of the targets : i.e. inclusion of all the sub_directories, in the correct order</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;- end with testing and doc</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;For the developper there is one major visible usage change : testing (still using ctest of course) can now be done from the build tree itself, i.e. without installation.</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;The main changes with respect to the current/previous situation are highlighted below.</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;### Preamble</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;CMake 3.13 is still the minimum version required. 3.14 would be interesting but is not critical. Note that when out CMake 3.15 will bring some generator expressions features that we might want to take advantage of (e.g. [REMOVE_DUPLICATES](https://gitlab.kitware.com/cmake/cmake/issues/18210)) and so might justify bumping the CMake version we use at that moment.</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;### Project wide setup</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;Here we have some basic sanity checks (forbid in-source builds for instance), perform some feature checks on the CXX compiler, set the default for our [build options](../cmake/O2DefineOptions.cmake), set the output directories and RPATH settings. Note the `BUILD_SIMULATION` option : currently used &quot;only&quot; to fetch more dependencies, but might imagine to actually group all the simulation-dependent parts of O2 into an optional component ? Not for now, but maybe a thing to consider for the future ?</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;Compared to previous usage, a `stage` area was added in the build tree, where (most of) the build artifacts are created. That&#39;s where you&#39;ll find the `bin`, `lib`, `share` directories instead of directly under the build topdir.</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;### External dependencies</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;Third-party dependencies are found in [dependencies/CMakeLists.txt](../dependencies/CMakeLists.txt).</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;`find_package` calls are of the `CONFIG` variety unless there&#39;s a compelling reason to use the `MODULE` version.</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;In particular :</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;- [FindFairRoot](../dependencies/FindFairRoot.cmake) is creating imported targets so we can use `FairRoot::XXX` targets even if those are not (yet) created by FairRoot itself. That file will disappear when FairRoot completes its own CMake migration.</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;- [FindGeant3](../dependencies/FindGeant3.cmake), [FindGeant4](../dependencies/FindGeant4.cmake), [Geant4VMC](../dependencies/FindGeant4VMC.cmake) : while those MC projects have Config.cmake files and thus define targets, they do not include the proper include paths for those targets. So those Find modules are just light ones that add the missing include paths to the imported targets defined in those projects.</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;- [Findpythia](../dependencies/Findpythia.cmake) (for Pythia8) and [Findpythia6](../dependencies/Findpythia6.cmake) define imported targets for those libraries</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;- [Findms_gsl](../dependencies/Findms_gsl.cmake) defines a `ms_gsl` target corresponding to the header only library</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;- [FindRapidJSON](../dependencies/FindRapidJSON.cmake) defines a `RapidJSON::RapidJSON` target corresponding to the header only library</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;As an aside, in order to ease the development of this new CMake system, a [o2_find_dependencies_from_alibuild](../dependencies/O2FindDependenciesFromAliBuild.cmake) function that &quot;detects&quot; the third-party dependencies from an AliBuild installation zone was developped. That might come in handy for other people too (e.g. those using IDEs like CLion ?)</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;### Definition of all targets</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;That part is the meat of the CMakeLists.txt and is just the inclusion of the relevant subdirectories, but with a catch : order matters ! Some dependency cycles that had been hidden with the bucket system now shows up ...</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;### Testing</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;Lastly some setup for testing is done in `tests` subdirectory. That part is still a bit WIP, but that&#39;s the location of the shell scripts that are used.</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;## Status at end of step 1</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;The way it was developped : first make a regular install of O2@dev using aliBuild.</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;Then switch to `cmake-migration-step-1` branch. Create a build directory somewhere, and run cmake there :</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;```</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;&gt; cd build-RelWithDebInfo</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;&gt; rm -rf *</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;&gt; cmake $HOME/alice/cmake/O2 -DCMAKE_BUILD_TYPE=RelWithDebInfo -DCMAKE_INSTALL_PREFIX=../install-RelWithDebInfo -DCMAKE_GENERATOR=Ninja -DALIBUILD_BASEDIR=$HOME/alice/cmake/sw/osx_x86-64</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;```</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;Use `ninja` to build, `cmake .` to force rerunning cmake. Rince and repeat. Do it on Mac(10.14) and on CentOS7.</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;The tests for this step (the failing test is only failing on CentOS7 in Debug configuration) :</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;```</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;~/alice/cmake/standalone/O2/build-Debug$ ctest --progress -j32</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;Test project /home/aphecetche/alice/cmake/standalone/O2/build-Debug</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;50/85 Test #34: O2test-dplutils-RootTreeWriterWorkflow..............***Failed    2.07 sec</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;85/85 Test #24: O2test-detectorsbase-MatBudLUT</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;99% tests passed, 1 tests failed out of 85</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;Label Time Summary:</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;dummy      =   0.11 sec*proc (2 tests)</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;example    =   0.05 sec*proc (1 test)</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;fast       =   0.16 sec*proc (3 tests)</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;gpu        =   2.13 sec*proc (2 tests)</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;its        =   1.06 sec*proc (1 test)</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;mch        =   0.42 sec*proc (8 tests)</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;mft        =   1.06 sec*proc (1 test)</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;mid        =  20.33 sec*proc (5 tests)</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;obvious    =   0.06 sec*proc (1 test)</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;slow       =  14.10 sec*proc (1 test)</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;steer      =   3.10 sec*proc (2 tests)</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;tpc        =  28.64 sec*proc (10 tests)</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;Total Test time (real) =  23.29 sec</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;The following tests FAILED:</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;         34 - O2test-dplutils-RootTreeWriterWorkflow (Failed)</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;Errors while running CTest</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;```</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;## Tips</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;### Getting the list of targets</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;In the build directory, if you do :</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;```</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;mkdir -p .cmake/api/v1/query/</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;touch .cmake/api/v1/query/codemodel-v2</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;```</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;Then after the cmake configure stage (if using CMake &gt;= 3.14) you&#39;ll get a list of JSON files describing the targets in the reply subdir :</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;```</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;&gt; tree .cmake/api/v1/reply</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;├── codemodel-v2-83681dd2d17b5fde868d.json</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;├── index-2019-06-11T10-25-54-0072.json</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;├── target-O2bench-mch-segmentation3-Debug-9c692e4e44d81a3a3a92.json</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;├── target-O2bench-mid-clusterizer-Debug-1340ba249c9a02e67ed5.json</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;├── target-O2bench-mid-tracker-Debug-3e2229d129fb77d3b863.json</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;├── target-O2exe-alicehlt-eventsampler-device-Debug-3bd0b54283972d791f58.json</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;├── target-O2exe-alicehlt-runcomponent-Debug-80eb80e9623ee42d3fb2.json</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160;├── target-O2exe-alicehlt-wrapper-device-Debug-10621b10deb5caf32c18.json</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160;├── target-O2exe-ccdb-conditions-client-Debug-07e6fca14004fe227979.json</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;├── target-O2exe-ccdb-conditions-server-Debug-ab5afdf6854abca507b7.json</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;├── target-O2exe-ccdb-standalone-client-Debug-aaff2add767f9b354708.json</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;```</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;## Step 2</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;This step is trying to get the GPU targets back in business. There are three versionsto consider: [HIP](../GPU/GPUTracking/Base/hip), [OpenCL](../GPU/GPUTracking/Base/opencl) and CUDA (for [TPC](..GPU/GPUTracking/Base/cuda) and [ITS](../Detectors/ITSMFT/ITS/tracking/cuda)).</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;In the `GPUTracking` all the AliRoot-specific references has been removed. They will need to be put back there if needed.</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;This step was tested on a CentOS7 server with OpenCL, HIP and CUDA dev. kits installed.</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;This step also brings a temporary [O2RecipeAdapter](../dependencies/O2RecipeAdapter.cmake) cmake include to be able to test this without having to modify (too much at least) the existing o2 recipe and CI.</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;## Step 3</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;In order to have the O2Suite building fine, step 3 is now the addition of the creation of a proper O2Config.cmake file, so that consumer packages (like QualityControl) can use our targets.</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;## Step 3 and 4</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;The proper generation of the O2Config.cmake (step 3) file has been done in anticipation for its usage by QualityControl.</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;The macro testing (step 4) is working, but only within the correct environment (i.e. within an alibuild build). The running of ctest without a prior environment will have to be deferred for later on, as it&#39;s not a completely trivial task (and is a departure from the current practice anyway)</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;[ ] Remaining to be done : generation of O2ConfigVersion.cmake file.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../dc/d3f/CMakeMigration_8md.html">CMakeMigration.md</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:32 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
