<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: /home/travis/build/AliceO2Group/AliceO2/CCDB/README.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d7/ddc/CCDB_2README_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/travis/build/AliceO2Group/AliceO2/CCDB/README.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d7/ddc/CCDB_2README_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;!-- doxy</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\page refCCDB Module &#39;CCDB&#39;</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/doxy --&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;# CCDB</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;The Conditions and Calibration DataBase provides a REST API which can be used to list, store and retrieve objects.</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;The CCDB API class (`CcdbApi`) is implemented using libcurl and gives C++ API</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160;access to the CCDB via its REST api. The API can be also used to create a snapshot</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;of conditions objects on the local disc and retrieve the objects therefrom. This can be useful</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;in circumstances of reduced or no network connectivity.</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;There are currently 2 different kinds of store/retrieve functions, which we expect to unify in the immediate future:</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;2. `storeAsTFile/retrieveFromTFile` API serializing a `TObject` in a ROOT `TFile`.</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;3. A strongly-typed `storeAsTFileAny&lt;T&gt;/retrieveFromTFileAny&lt;T&gt;` API allowing to handle any type T </div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;   having a ROOT dictionary. We encourage to use this API by default.</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;## Central and local instances of the CCDB</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;There is a test central CCDB at [http://ccdb-test.cern.ch:8080](http://ccdb-test.cern.ch:8080). Feel free to use it. If you prefer to use a local instance, you can follow the instructions [here](https://docs.google.com/document/d/1_GM6yY7ejVEIRi1y8Ooc9ongrGgZyCiks6Ca0OAEav8).</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;## Access with a browser</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;If you access the CCDB with a web browser, add `/browse` at the end of the URL to have a user readable interface. Moreover, using `/browse/?report=true` will provide details on the number of files and the size of the folders (e.g. http://ccdb-test.cern.ch:8080/browse/?report=true).</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;## Example Usage</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;* storing / retrieving arbitrary (non TObject) classes</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;```c++</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;// init</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;CcdbApi api;</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;map&lt;string, string&gt; metadata; // can be empty</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;api.init(&quot;http://ccdb-test.cern.ch:8080&quot;); // or http://localhost:8080 for a local installation</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;// store abitrary user object in strongly typed manner</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;auto deadpixels = new o2::FOO::DeadPixelMap();</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;api.storeAsTFileAny(deadpixels, &quot;FOO/DeadPixels&quot;, metadata);</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;// read like this (you have to specify the type)</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;auto deadpixelsback = api.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(&quot;FOO/DeadPixels&quot;, metadata); </div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;// read like this to get the headers as well, and thus the metadata attached to the object </div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;map&lt;string, string&gt; headers;</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;auto deadpixelsback = api.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(&quot;FOO/DeadPixels&quot;, metadata /* constraint the objects retrieved to those matching the metadata */, -1 /* timestamp */, &amp;headers /* the headers attached to the returned object */); </div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;// finally, use this method to retrieve only the headers (and thus the metadata)</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;std::map&lt;std::string, std::string&gt; headers = f.api.retrieveHeaders(&quot;FOO/DeadPixels&quot;, f.metadata); </div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;```</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;* creating a local snapshot and fetching objects therefrom</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;```c++</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;// init</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;CcdbApi api;</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;map&lt;string, string&gt; metadata; // can be empty</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;api.init(&quot;http://ccdb-test.cern.ch:8080&quot;); // or http://localhost:8080 for a local installation</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;// create a local snapshot of everthing in or below the FOO folder valid for timestamp 12345</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;api.snapshot(&quot;FOO&quot;, &quot;/tmp/CCDBSnapshot/&quot;, 12345);</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;// read from snapshot by saying</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;CcdbApi snapshotapi;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;snaptshotapi.init(&quot;file:///tmp/CCDBSnapshot&quot;);</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;// reading still works just like this (you have to specify the type)</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;auto deadpixelsback = snapshotapi.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(&quot;FOO/DeadPixels&quot;, metadata);</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;```</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;# BasicCCDBManager</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;A basic higher level class `BasicCCDBManager` is offered for convenient access to the CCDB from</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;user code. This class</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;* Encapsulates the timestamp.</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;* Offers a more convenient `get` function to retrieve objects.</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;* Is a singleton which is initialized once and can be used from any detector code.</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;The class was written for the use-case of transport MC simulation. Typical usage should be like</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;```c++</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;// setup manager once (at start of processing) </div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;auto&amp; mgr = o2::ccdb::BasicCCDBManager::instance();</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;mgr.setURL(&quot;http://ourccdbserverver.cern.ch&quot;);</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;mgr.setTimestamp(timestamp_which_we_want_to_anchor_to);</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;// in some FOO detector code (detector initialization)</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;auto&amp; mgr = o2::ccdb::BasicCCDBManager::instance();</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;// just give the correct path and you will be served the object</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;auto alignment = mgr.get&lt;o2::FOO::GeomAlignment&gt;(&quot;/FOO/Alignment&quot;);</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;```</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;By default loaded object are cached in the `BasicCCDBManager` and owned by it, therefore user should not delete retrieved objects.</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;If the query is done for the object which is already in the cache, its pointer is returned instead of loading again the object from the CCDB server,</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;unless the validity range of the cached object does not match to requested timestamp.</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;In case user wants to enforce a fresh copy loading, the cache for particular CCDB path can be cleaned by invoking `mgr.clear(&lt;path&gt;)`.</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;One can also reset whole cache using `mgr.clear()`.</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;Uncached mode can be imposed by invoking `mgr.setCachingEnabled(false)`, in which case every query will retrieve a new copy of object from the server and</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;the user should take care himself of deleting retrieved objects to avoid memory leaks.</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;## Future ideas / todo:</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;</div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;- [ ] offer improved error handling / exceptions</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;- [ ] do we need a store method?</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;- [ ] offer API without need to pass metadata object</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;- [ ] code reduction or delegation between various storeAsTFile APIs</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;- [ ] eventually just call the functions store/retrieve once TMessage is disabled</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;## Note on the use of TFile to store data</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;The reason for using a TFile to store the data in the CCDB is because it has the advantage of keeping the data together with the ROOT streamer info in the same place and because it makes it easy to open objects directly from a ROOT session. The streamers enable class schema evolution.</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;## Command line tools</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;A few prototypic command line tools are offered. These can be used in scriptable generic workflows</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;and facilitate the following tasks:</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;  1. Upload and annotate a generic C++ object serialized in a ROOT file</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;  </div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;     ```bash</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;     o2-ccdb-upload -f myRootFile.root --key histogram1 --path /Detector1/QA/ --meta &quot;Description=Foo;Author=Person1;Uploader=Person2&quot;</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;     ```</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;     This will upload the object serialized in `myRootFile.root` under the key `histogram1`. Object will be put to the CCDB path `/Detector1/QA`.</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;     For full list of options see `o2-ccdb-upload --help`.</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;  </div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;  2. Download a CCDB object to a local ROOT file (including its meta information)</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;  </div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;     ```bash</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;     o2-ccdb-downloadccdbfile --path /Detector1/QA/ --dest /tmp/CCDB --timestamp xxx</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;     ```</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;     This will download the CCDB object under path given by `--path` to a directory given by `--dest` on the disc.</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;     (The final filename will be `/tmp/CCDB/Detector1/QA/snapshot.root` for the moment).</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;     All meta-information as well as the information associated to this query will be appended to the file.</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;     </div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;     For full list of options see `o2-ccdb-downloadccdbfile --help`.</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;  </div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;  3. Inspect the content of a ROOT file and print summary about type of contained (CCDB) objects and its meta information</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;  </div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;     ```bash</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;     o2-ccdb-inspectccdbfile filename</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;     ```</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;     Lists all keys and stored types in a ROOT file (downloaded with tool `o2-ccdb-downloadccdbfile`) and prints a summary about the attached meta-information.</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;### TODO command line tools</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;- [ ] combine all tools into a single swiss-knife executable?</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;- [ ] offer more tools mapping all REST functionality of the server: be able to browse, list, query online content, etc.</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;- [ ] provide error diagnostics; different level of verbosity</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;- [ ] provide json interaction modes (give meta-information; retrieve meta-information)</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;- [ ] use meta-info filters when downloading</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d7/ddc/CCDB_2README_8md.html">README.md</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:20 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
