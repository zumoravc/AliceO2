<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: Module &#39;CCDB&#39;</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d8/d62/refCCDB.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">Module 'CCDB' </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><h1>CCDB</h1>
<p>The Conditions and Calibration DataBase provides a REST API which can be used to list, store and retrieve objects.</p>
<p>The CCDB API class (<code>CcdbApi</code>) is implemented using libcurl and gives C++ API access to the CCDB via its REST api. The API can be also used to create a snapshot of conditions objects on the local disc and retrieve the objects therefrom. This can be useful in circumstances of reduced or no network connectivity.</p>
<p>There are currently 2 different kinds of store/retrieve functions, which we expect to unify in the immediate future:</p><ol type="1">
<li><code>storeAsTFile/retrieveFromTFile</code> API serializing a <code><a class="el" href="../../d5/d0f/classTObject.html">TObject</a></code> in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> <code>TFile</code>.</li>
<li><a class="el" href="../../d2/d88/classA.html">A</a> strongly-typed <code>storeAsTFileAny&lt;<a class="el" href="../../d1/def/classT.html">T</a>&gt;/retrieveFromTFileAny&lt;<a class="el" href="../../d1/def/classT.html">T</a>&gt;</code> API allowing to handle any type <a class="el" href="../../d1/def/classT.html">T</a> having a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> dictionary. We encourage to use this API by default.</li>
</ol>
<h2>Central and local instances of the CCDB</h2>
<p>There is a test central CCDB at <a href="http://ccdb-test.cern.ch:8080">http://ccdb-test.cern.ch:8080</a>. Feel free to use it. If you prefer to use a local instance, you can follow the instructions <a href="https://docs.google.com/document/d/1_GM6yY7ejVEIRi1y8Ooc9ongrGgZyCiks6Ca0OAEav8">here</a>.</p>
<h2>Access with a browser</h2>
<p>If you access the CCDB with a web browser, add <code>/browse</code> at the end of the URL to have a user readable interface. Moreover, using <code>/browse/?report=true</code> will provide details on the number of files and the size of the folders (e.g. <a href="http://ccdb-test.cern.ch:8080/browse/?report=true">http://ccdb-test.cern.ch:8080/browse/?report=true</a>).</p>
<h2>Example Usage</h2>
<ul>
<li>storing / retrieving arbitrary (non <a class="el" href="../../d5/d0f/classTObject.html">TObject</a>) classes</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">// init</span></div><div class="line">CcdbApi api;</div><div class="line">map&lt;string, string&gt; metadata; <span class="comment">// can be empty</span></div><div class="line">api.init(<span class="stringliteral">&quot;http://ccdb-test.cern.ch:8080&quot;</span>); <span class="comment">// or http://localhost:8080 for a local installation</span></div><div class="line"><span class="comment">// store abitrary user object in strongly typed manner</span></div><div class="line"><span class="keyword">auto</span> deadpixels = <span class="keyword">new</span> o2::FOO::DeadPixelMap();</div><div class="line">api.storeAsTFileAny(deadpixels, <span class="stringliteral">&quot;FOO/DeadPixels&quot;</span>, metadata);</div><div class="line"><span class="comment">// read like this (you have to specify the type)</span></div><div class="line"><span class="keyword">auto</span> deadpixelsback = api.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(<span class="stringliteral">&quot;FOO/DeadPixels&quot;</span>, metadata); </div><div class="line"><span class="comment">// read like this to get the headers as well, and thus the metadata attached to the object </span></div><div class="line">map&lt;string, string&gt; headers;</div><div class="line"><span class="keyword">auto</span> deadpixelsback = api.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(<span class="stringliteral">&quot;FOO/DeadPixels&quot;</span>, metadata <span class="comment">/* constraint the objects retrieved to those matching the metadata */</span>, -1 <span class="comment">/* timestamp */</span>, &amp;headers <span class="comment">/* the headers attached to the returned object */</span>); </div><div class="line"><span class="comment">// finally, use this method to retrieve only the headers (and thus the metadata)</span></div><div class="line">std::map&lt;std::string, std::string&gt; headers = <a class="code" href="../../dc/da3/glcorearb_8h.html#a1fe2b9d716f80da76adb19505d583dc1">f</a>.api.retrieveHeaders(<span class="stringliteral">&quot;FOO/DeadPixels&quot;</span>, <a class="code" href="../../dc/da3/glcorearb_8h.html#a1fe2b9d716f80da76adb19505d583dc1">f</a>.metadata); </div></div><!-- fragment --><ul>
<li>creating a local snapshot and fetching objects therefrom</li>
</ul>
<div class="fragment"><div class="line"><span class="comment">// init</span></div><div class="line">CcdbApi api;</div><div class="line">map&lt;string, string&gt; metadata; <span class="comment">// can be empty</span></div><div class="line">api.init(<span class="stringliteral">&quot;http://ccdb-test.cern.ch:8080&quot;</span>); <span class="comment">// or http://localhost:8080 for a local installation</span></div><div class="line"><span class="comment">// create a local snapshot of everthing in or below the FOO folder valid for timestamp 12345</span></div><div class="line">api.snapshot(<span class="stringliteral">&quot;FOO&quot;</span>, <span class="stringliteral">&quot;/tmp/CCDBSnapshot/&quot;</span>, 12345);</div><div class="line"></div><div class="line"><span class="comment">// read from snapshot by saying</span></div><div class="line">CcdbApi snapshotapi;</div><div class="line">snaptshotapi.init(<span class="stringliteral">&quot;file:///tmp/CCDBSnapshot&quot;</span>);</div><div class="line"></div><div class="line"><span class="comment">// reading still works just like this (you have to specify the type)</span></div><div class="line"><span class="keyword">auto</span> deadpixelsback = snapshotapi.retrieveFromTFileAny&lt;o2::FOO::DeadPixelMap&gt;(<span class="stringliteral">&quot;FOO/DeadPixels&quot;</span>, metadata);</div></div><!-- fragment --><h1>BasicCCDBManager</h1>
<p><a class="el" href="../../d2/d88/classA.html">A</a> basic higher level class <code>BasicCCDBManager</code> is offered for convenient access to the CCDB from user code. This class</p><ul>
<li>Encapsulates the timestamp.</li>
<li>Offers a more convenient <code>get</code> function to retrieve objects.</li>
<li>Is a singleton which is initialized once and can be used from any detector code.</li>
</ul>
<p>The class was written for the use-case of transport MC simulation. Typical usage should be like</p>
<div class="fragment"><div class="line"><span class="comment">// setup manager once (at start of processing) </span></div><div class="line"><span class="keyword">auto</span>&amp; mgr = <a class="code" href="../../da/d73/classo2_1_1ccdb_1_1BasicCCDBManager.html#ac829fb69185587ba263490a43eab67d8">o2::ccdb::BasicCCDBManager::instance</a>();</div><div class="line">mgr.setURL(<span class="stringliteral">&quot;http://ourccdbserverver.cern.ch&quot;</span>);</div><div class="line">mgr.setTimestamp(timestamp_which_we_want_to_anchor_to);</div><div class="line"></div><div class="line"></div><div class="line"><span class="comment">// in some FOO detector code (detector initialization)</span></div><div class="line"><span class="keyword">auto</span>&amp; mgr = <a class="code" href="../../da/d73/classo2_1_1ccdb_1_1BasicCCDBManager.html#ac829fb69185587ba263490a43eab67d8">o2::ccdb::BasicCCDBManager::instance</a>();</div><div class="line"><span class="comment">// just give the correct path and you will be served the object</span></div><div class="line"><span class="keyword">auto</span> alignment = mgr.get&lt;o2::FOO::GeomAlignment&gt;(<span class="stringliteral">&quot;/FOO/Alignment&quot;</span>);</div></div><!-- fragment --><p>By default loaded object are cached in the <code>BasicCCDBManager</code> and owned by it, therefore user should not delete retrieved objects. If the query is done for the object which is already in the cache, its pointer is returned instead of loading again the object from the CCDB server, unless the validity range of the cached object does not match to requested timestamp. In case user wants to enforce a fresh copy loading, the cache for particular CCDB path can be cleaned by invoking <code>mgr.clear(&lt;path&gt;)</code>. One can also reset whole cache using <code><a class="el" href="../../df/d18/namespaceo2_1_1mid.html#aca82e9e929edf59c003b2a1b07a3ec69">mgr.clear()</a></code>.</p>
<p>Uncached mode can be imposed by invoking <code>mgr.setCachingEnabled(false)</code>, in which case every query will retrieve a new copy of object from the server and the user should take care himself of deleting retrieved objects to avoid memory leaks.</p>
<h2>Future ideas / todo:</h2>
<ul>
<li>[ ] offer improved error handling / exceptions</li>
<li>[ ] do we need a store method?</li>
<li>[ ] offer API without need to pass metadata object</li>
<li>[ ] code reduction or delegation between various storeAsTFile APIs</li>
<li>[ ] eventually just call the functions store/retrieve once <a class="el" href="../../d9/dc7/classTMessage.html">TMessage</a> is disabled</li>
</ul>
<h2>Note on the use of TFile to store data</h2>
<p>The reason for using a TFile to store the data in the CCDB is because it has the advantage of keeping the data together with the <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> streamer info in the same place and because it makes it easy to open objects directly from a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> session. The streamers enable class schema evolution.</p>
<h2>Command line tools</h2>
<p><a class="el" href="../../d2/d88/classA.html">A</a> few prototypic command line tools are offered. These can be used in scriptable generic workflows and facilitate the following tasks:</p>
<ol type="1">
<li><p class="startli">Upload and annotate a generic C++ object serialized in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file</p>
<p class="startli">~~~{.sh} o2-ccdb-upload -f myRootFile.root &ndash;key histogram1 &ndash;path /Detector1/QA/ &ndash;meta "Description=Foo;Author=Person1;Uploader=Person2" ~~~ This will upload the object serialized in <code>myRootFile.root</code> under the key <code>histogram1</code>. Object will be put to the CCDB path <code>/Detector1/QA</code>. For full list of options see <code>o2-ccdb-upload --help</code>.</p>
</li>
<li><p class="startli">Download a CCDB object to a local <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file (including its meta information)</p>
<p class="startli">~~~{.sh} o2-ccdb-downloadccdbfile &ndash;path /Detector1/QA/ &ndash;dest /tmp/CCDB &ndash;timestamp xxx ~~~ This will download the CCDB object under path given by <code>--path</code> to a directory given by <code>--dest</code> on the disc. (The final filename will be <code>/tmp/CCDB/Detector1/QA/snapshot.root</code> for the moment). All meta-information as well as the information associated to this query will be appended to the file.</p>
<p class="startli">For full list of options see <code>o2-ccdb-downloadccdbfile --help</code>.</p>
</li>
<li><p class="startli">Inspect the content of a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file and print summary about type of contained (CCDB) objects and its meta information</p>
<p class="startli">~~~{.sh} o2-ccdb-inspectccdbfile filename ~~~ Lists all keys and stored types in a <a class="el" href="../../d0/d10/namespaceROOT.html">ROOT</a> file (downloaded with tool <code>o2-ccdb-downloadccdbfile</code>) and prints a summary about the attached meta-information.</p>
</li>
</ol>
<h3>TODO command line tools</h3>
<ul>
<li>[ ] combine all tools into a single swiss-knife executable?</li>
<li>[ ] offer more tools mapping all REST functionality of the server: be able to browse, list, query online content, etc.</li>
<li>[ ] provide error diagnostics; different level of verbosity</li>
<li>[ ] provide json interaction modes (give meta-information; retrieve meta-information)</li>
<li>[ ] use meta-info filters when downloading </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:40 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
