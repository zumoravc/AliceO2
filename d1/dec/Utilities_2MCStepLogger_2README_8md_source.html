<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Project: /home/travis/build/AliceO2Group/AliceO2/Utilities/MCStepLogger/README.md Source File</title>
<link href="../../tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../jquery.js"></script>
<script type="text/javascript" src="../../dynsections.js"></script>
<link href="../../navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../resize.js"></script>
<script type="text/javascript" src="../../navtreedata.js"></script>
<script type="text/javascript" src="../../navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="../../search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="../../search/searchdata.js"></script>
<script type="text/javascript" src="../../search/search.js"></script>
<link href="../../doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectlogo"><img alt="Logo" src="../../o2_logo.png"/></td>
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">Project
   </div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "../../search",false,'Search');
</script>
<script type="text/javascript" src="../../menudata.js"></script>
<script type="text/javascript" src="../../menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('../../',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('d1/dec/Utilities_2MCStepLogger_2README_8md.html','../../');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">/home/travis/build/AliceO2Group/AliceO2/Utilities/MCStepLogger/README.md</div>  </div>
</div><!--header-->
<div class="contents">
<a href="../../d1/dec/Utilities_2MCStepLogger_2README_8md.html">Go to the documentation of this file.</a><div class="fragment"><div class="line"><a name="l00001"></a><span class="lineno">    1</span>&#160;&lt;!-- doxy</div><div class="line"><a name="l00002"></a><span class="lineno">    2</span>&#160;\page refUtilitiesMCStepLogger MCStepLogger</div><div class="line"><a name="l00003"></a><span class="lineno">    3</span>&#160;/doxy --&gt;</div><div class="line"><a name="l00004"></a><span class="lineno">    4</span>&#160;</div><div class="line"><a name="l00005"></a><span class="lineno">    5</span>&#160;### NOTE: The MCStepLogger has moved to https://github.com/AliceO2Group/VMCStepLogger.git</div><div class="line"><a name="l00006"></a><span class="lineno">    6</span>&#160;</div><div class="line"><a name="l00007"></a><span class="lineno">    7</span>&#160;## MCStepLogger</div><div class="line"><a name="l00008"></a><span class="lineno">    8</span>&#160;</div><div class="line"><a name="l00009"></a><span class="lineno">    9</span>&#160;Detailed debug information about stepping can be directed to standard output using the `LD_PRELOAD` env variable, which &quot;injects&quot; a</div><div class="line"><a name="l00010"></a><span class="lineno">   10</span>&#160; special logging library (which intercepts some calls) in the executable that follows in the command line.</div><div class="line"><a name="l00011"></a><span class="lineno">   11</span>&#160;</div><div class="line"><a name="l00012"></a><span class="lineno">   12</span>&#160;```bash</div><div class="line"><a name="l00013"></a><span class="lineno">   13</span>&#160;LD_PRELOAD=path_to/libMCStepLogger.so o2sim -m MCH -n 10</div><div class="line"><a name="l00014"></a><span class="lineno">   14</span>&#160;```</div><div class="line"><a name="l00015"></a><span class="lineno">   15</span>&#160;</div><div class="line"><a name="l00016"></a><span class="lineno">   16</span>&#160;</div><div class="line"><a name="l00017"></a><span class="lineno">   17</span>&#160;```</div><div class="line"><a name="l00018"></a><span class="lineno">   18</span>&#160;[MCLOGGER:] START FLUSHING ----</div><div class="line"><a name="l00019"></a><span class="lineno">   19</span>&#160;[STEPLOGGER]: did 28 steps</div><div class="line"><a name="l00020"></a><span class="lineno">   20</span>&#160;[STEPLOGGER]: transported 1 different tracks</div><div class="line"><a name="l00021"></a><span class="lineno">   21</span>&#160;[STEPLOGGER]: transported 1 different types</div><div class="line"><a name="l00022"></a><span class="lineno">   22</span>&#160;[STEPLOGGER]: VolName cave COUNT 23 SECONDARIES 0</div><div class="line"><a name="l00023"></a><span class="lineno">   23</span>&#160;[STEPLOGGER]: VolName normalPCB1 COUNT 3 SECONDARIES 0</div><div class="line"><a name="l00024"></a><span class="lineno">   24</span>&#160;[STEPLOGGER]: ----- END OF EVENT ------</div><div class="line"><a name="l00025"></a><span class="lineno">   25</span>&#160;[FIELDLOGGER]: did 21 steps</div><div class="line"><a name="l00026"></a><span class="lineno">   26</span>&#160;[FIELDLOGGER]: VolName cave COUNT 20</div><div class="line"><a name="l00027"></a><span class="lineno">   27</span>&#160;[FIELDLOGGER]: ----- END OF EVENT ------</div><div class="line"><a name="l00028"></a><span class="lineno">   28</span>&#160;[MCLOGGER:] END FLUSHING ----</div><div class="line"><a name="l00029"></a><span class="lineno">   29</span>&#160;```</div><div class="line"><a name="l00030"></a><span class="lineno">   30</span>&#160;</div><div class="line"><a name="l00031"></a><span class="lineno">   31</span>&#160;The stepping logger information can also be directed to an output tree for more detailed investigations.</div><div class="line"><a name="l00032"></a><span class="lineno">   32</span>&#160;Default name is `MCStepLoggerOutput.root` (and can be changed</div><div class="line"><a name="l00033"></a><span class="lineno">   33</span>&#160;by setting the `MCSTEPLOG_OUTFILE` env variable).</div><div class="line"><a name="l00034"></a><span class="lineno">   34</span>&#160;</div><div class="line"><a name="l00035"></a><span class="lineno">   35</span>&#160;```bash</div><div class="line"><a name="l00036"></a><span class="lineno">   36</span>&#160;MCSTEPLOG_TTREE=1 LD_PRELOAD=path_to/libMCStepLogger.so o2sim ..</div><div class="line"><a name="l00037"></a><span class="lineno">   37</span>&#160;```</div><div class="line"><a name="l00038"></a><span class="lineno">   38</span>&#160;</div><div class="line"><a name="l00039"></a><span class="lineno">   39</span>&#160;Finally the logger can use a map file to give names to some logical grouping of volumes. For instance to map all sensitive volumes from a given detector `DET` to a common label `DET`. That label can then be used to query information about the detector steps &quot;as a whole&quot; when using the `StepLoggerTree` output tree.</div><div class="line"><a name="l00040"></a><span class="lineno">   40</span>&#160;</div><div class="line"><a name="l00041"></a><span class="lineno">   41</span>&#160;```bash</div><div class="line"><a name="l00042"></a><span class="lineno">   42</span>&#160;&gt; cat volmapfile.dat</div><div class="line"><a name="l00043"></a><span class="lineno">   43</span>&#160;normalPCB1 MCH</div><div class="line"><a name="l00044"></a><span class="lineno">   44</span>&#160;normalPCB2 MCH</div><div class="line"><a name="l00045"></a><span class="lineno">   45</span>&#160;normalPCB3 MCH</div><div class="line"><a name="l00046"></a><span class="lineno">   46</span>&#160;normalPCB4 MCH</div><div class="line"><a name="l00047"></a><span class="lineno">   47</span>&#160;normalPCB5 MCH</div><div class="line"><a name="l00048"></a><span class="lineno">   48</span>&#160;normalPCB6 MCH</div><div class="line"><a name="l00049"></a><span class="lineno">   49</span>&#160;centralPCB MCH</div><div class="line"><a name="l00050"></a><span class="lineno">   50</span>&#160;downroundedPCB MCH</div><div class="line"><a name="l00051"></a><span class="lineno">   51</span>&#160;uproundedPCB MCH</div><div class="line"><a name="l00052"></a><span class="lineno">   52</span>&#160;cave TheCavern</div><div class="line"><a name="l00053"></a><span class="lineno">   53</span>&#160;</div><div class="line"><a name="l00054"></a><span class="lineno">   54</span>&#160;&gt; MCSTEPLOG_VOLMAPFILE=path_to_/volmapfile.dat MCSTEPLOG_TTREE=1 LD_PRELOAD=path_to/libMCStepLogger.so o2sim ..</div><div class="line"><a name="l00055"></a><span class="lineno">   55</span>&#160;</div><div class="line"><a name="l00056"></a><span class="lineno">   56</span>&#160;&gt; root -b MCStepLoggerOutput.root</div><div class="line"><a name="l00057"></a><span class="lineno">   57</span>&#160;root[0] StepLoggerTree-&gt;Draw(&quot;Lookups.volidtomodule.data()&quot;);</div><div class="line"><a name="l00058"></a><span class="lineno">   58</span>&#160;```</div><div class="line"><a name="l00059"></a><span class="lineno">   59</span>&#160;</div><div class="line"><a name="l00060"></a><span class="lineno">   60</span>&#160;Note also the existence of the `LD_DEBUG` variable which can be used to see in details what libraries are loaded (and much more if needed...).</div><div class="line"><a name="l00061"></a><span class="lineno">   61</span>&#160;</div><div class="line"><a name="l00062"></a><span class="lineno">   62</span>&#160;```bash</div><div class="line"><a name="l00063"></a><span class="lineno">   63</span>&#160;LD_DEBUG=libs o2sim</div><div class="line"><a name="l00064"></a><span class="lineno">   64</span>&#160;LD_DEBUG=help o2sim</div><div class="line"><a name="l00065"></a><span class="lineno">   65</span>&#160;```</div><div class="line"><a name="l00066"></a><span class="lineno">   66</span>&#160;</div><div class="line"><a name="l00067"></a><span class="lineno">   67</span>&#160;## Special case on macOS</div><div class="line"><a name="l00068"></a><span class="lineno">   68</span>&#160;</div><div class="line"><a name="l00069"></a><span class="lineno">   69</span>&#160;`LD_PRELOAD` must be replaced by `DYLD_INSERT_LIBRARIES`, e.g. :</div><div class="line"><a name="l00070"></a><span class="lineno">   70</span>&#160;</div><div class="line"><a name="l00071"></a><span class="lineno">   71</span>&#160;```bash</div><div class="line"><a name="l00072"></a><span class="lineno">   72</span>&#160;DYLD_INSERT_LIBRARIES=/Users/laurent/alice/sw/osx_x86-64/O2/latest-clion-o2/lib/libMCStepLogger.dylib MCSTEPLOG_TTREE=1 MCSTEPLOG_OUTFILE=toto.root o2sim -m MCH -g mugen -n 1</div><div class="line"><a name="l00073"></a><span class="lineno">   73</span>&#160;```</div><div class="line"><a name="l00074"></a><span class="lineno">   74</span>&#160;</div><div class="line"><a name="l00075"></a><span class="lineno">   75</span>&#160;`LD_DEBUG=libs` must be replaced by `DYLD_PRINT_LIBRARIES=1`</div><div class="line"><a name="l00076"></a><span class="lineno">   76</span>&#160;</div><div class="line"><a name="l00077"></a><span class="lineno">   77</span>&#160;`LD_DEBUG=statistics` must be replaced by `DYLD_PRINT_STATISTICS=1`</div><div class="line"><a name="l00078"></a><span class="lineno">   78</span>&#160;</div><div class="line"><a name="l00079"></a><span class="lineno">   79</span>&#160;</div><div class="line"><a name="l00080"></a><span class="lineno">   80</span>&#160;## MCStepLogAnalysis</div><div class="line"><a name="l00081"></a><span class="lineno">   81</span>&#160;</div><div class="line"><a name="l00082"></a><span class="lineno">   82</span>&#160;Information collected and stored in `MCStepLoggerOutput.root` can be further investigated using the excutable `mcStepAnalysis`. This executable is independent of the simulation itself and produces therefore no overhead when running a simulation. 2 commands are so far available (`analyze`, `checkFile`) including useful help message when typing</div><div class="line"><a name="l00083"></a><span class="lineno">   83</span>&#160;```bash</div><div class="line"><a name="l00084"></a><span class="lineno">   84</span>&#160;mcStepAnalysis &lt;command&gt; --help</div><div class="line"><a name="l00085"></a><span class="lineno">   85</span>&#160;```</div><div class="line"><a name="l00086"></a><span class="lineno">   86</span>&#160;</div><div class="line"><a name="l00087"></a><span class="lineno">   87</span>&#160;### File formats</div><div class="line"><a name="l00088"></a><span class="lineno">   88</span>&#160;</div><div class="line"><a name="l00089"></a><span class="lineno">   89</span>&#160;2 file formats having a standardised structure play a role. On one hand, these are the files produced by the step logging which are the input files for the analysis as explained in the following. On the other hand, each analysis produces an output file containing histograms along with some meta information. Sanity and the type of the file can be checked via</div><div class="line"><a name="l00090"></a><span class="lineno">   90</span>&#160;```bash</div><div class="line"><a name="l00091"></a><span class="lineno">   91</span>&#160;mcStepAnalysis checkFile -f &lt;FileToBeChecked&gt;</div><div class="line"><a name="l00092"></a><span class="lineno">   92</span>&#160;```</div><div class="line"><a name="l00093"></a><span class="lineno">   93</span>&#160;### Analysing the steps</div><div class="line"><a name="l00094"></a><span class="lineno">   94</span>&#160;</div><div class="line"><a name="l00095"></a><span class="lineno">   95</span>&#160;The basic command containing all required parameters is</div><div class="line"><a name="l00096"></a><span class="lineno">   96</span>&#160;```bash</div><div class="line"><a name="l00097"></a><span class="lineno">   97</span>&#160;mcStepAnalysis analyze -f &lt;MCStepLoggerOutputFile&gt; -o &lt;parent/output/dir&gt; -l &lt;label&gt;</div><div class="line"><a name="l00098"></a><span class="lineno">   98</span>&#160;```</div><div class="line"><a name="l00099"></a><span class="lineno">   99</span>&#160;where  </div><div class="line"><a name="l00100"></a><span class="lineno">  100</span>&#160;* `-f &lt;MCStepLoggerOutputFile&gt;` passes the input file produced with the `MCStepLogger` as explained above (default name is `MCStepLoggerOutput.root`)</div><div class="line"><a name="l00101"></a><span class="lineno">  101</span>&#160;* `-o &lt;parent/output/dir&gt;` provides the top directory for the analysis output (if this does not exist, it is created automatically)</div><div class="line"><a name="l00102"></a><span class="lineno">  102</span>&#160;* `-l &lt;label&gt;` adds a label, e.g. for plots produced later.</div><div class="line"><a name="l00103"></a><span class="lineno">  103</span>&#160;</div><div class="line"><a name="l00104"></a><span class="lineno">  104</span>&#160;A `ROOT` file at `parent/output/dir/MetaAnalysis/Analysis.root` is produced containing all histograms as well as important meta information. Histogram objects are derived from `ROOT`s `TH1` classes.</div><div class="line"><a name="l00105"></a><span class="lineno">  105</span>&#160;</div><div class="line"><a name="l00106"></a><span class="lineno">  106</span>&#160;### Further processing of analysis files</div><div class="line"><a name="l00107"></a><span class="lineno">  107</span>&#160;</div><div class="line"><a name="l00108"></a><span class="lineno">  108</span>&#160;Files produced as described before can be investigated further or used to plot the histograms therein. The interface to read these files is the class `AnalysisFile` and histograms can be requested by their names.</div><div class="line"><a name="l00109"></a><span class="lineno">  109</span>&#160;```c++</div><div class="line"><a name="l00110"></a><span class="lineno">  110</span>&#160;// somthing...</div><div class="line"><a name="l00111"></a><span class="lineno">  111</span>&#160;#include &quot;MCStepLogger/AnalysisFile.h&quot;</div><div class="line"><a name="l00112"></a><span class="lineno">  112</span>&#160;// some code</div><div class="line"><a name="l00113"></a><span class="lineno">  113</span>&#160;AnalysisFile af;</div><div class="line"><a name="l00114"></a><span class="lineno">  114</span>&#160;af.read(&quot;path/to/file.root&quot;);</div><div class="line"><a name="l00115"></a><span class="lineno">  115</span>&#160;// print meta info</div><div class="line"><a name="l00116"></a><span class="lineno">  116</span>&#160;af.printMetaInfo();</div><div class="line"><a name="l00117"></a><span class="lineno">  117</span>&#160;// get a histogram by name (program will exit if name not found)</div><div class="line"><a name="l00118"></a><span class="lineno">  118</span>&#160;TH1&amp; histogram = af.getHistogram(&quot;nameOfHistogram&quot;);</div><div class="line"><a name="l00119"></a><span class="lineno">  119</span>&#160;// if you know the underlying object is, e.g. of derived class TH1D and you really need that you can do</div><div class="line"><a name="l00120"></a><span class="lineno">  120</span>&#160;TH1D&amp; otherHistogramCasted = af.getHistogram&lt;TH1D&gt;(&quot;nameOfOtherHistogram&quot;);</div><div class="line"><a name="l00121"></a><span class="lineno">  121</span>&#160;// where the program will safely exit immediately in case the casting was not successful</div><div class="line"><a name="l00122"></a><span class="lineno">  122</span>&#160;//...</div><div class="line"><a name="l00123"></a><span class="lineno">  123</span>&#160;// modify histogram or do other things</div><div class="line"><a name="l00124"></a><span class="lineno">  124</span>&#160;//...</div><div class="line"><a name="l00125"></a><span class="lineno">  125</span>&#160;//to save changes made to histograms do</div><div class="line"><a name="l00126"></a><span class="lineno">  126</span>&#160;af.write(&quot;path/to/output/file.root&quot;);</div><div class="line"><a name="l00127"></a><span class="lineno">  127</span>&#160;```</div><div class="line"><a name="l00128"></a><span class="lineno">  128</span>&#160;### Additional information about the `MCAnalysisManager`</div><div class="line"><a name="l00129"></a><span class="lineno">  129</span>&#160;</div><div class="line"><a name="l00130"></a><span class="lineno">  130</span>&#160;There is the staic method `MCAnalysisManager::Instance()` which returns a reference to a static instance. So always make sure you don&#39;t copy it but get the reference in case you want to work with that instance on a global scope, i.e.</div><div class="line"><a name="l00131"></a><span class="lineno">  131</span>&#160;```c++</div><div class="line"><a name="l00132"></a><span class="lineno">  132</span>&#160;// some code</div><div class="line"><a name="l00133"></a><span class="lineno">  133</span>&#160;auto&amp; anamgr = MCAnalysisManager::Instance();</div><div class="line"><a name="l00134"></a><span class="lineno">  134</span>&#160;```</div><div class="line"><a name="l00135"></a><span class="lineno">  135</span>&#160;### Additional information about the analysis objects</div><div class="line"><a name="l00136"></a><span class="lineno">  136</span>&#160;</div><div class="line"><a name="l00137"></a><span class="lineno">  137</span>&#160;Histograms which should be written to disk in an analysis are managed by `MCAnalysisFileWrapper` objects. These also make sure that no histogram is created twice. Therefore, all of these histograms should be created like `T* myHisto = MCAnalysis::getHistogram&lt;T&gt;(...)` where the template parameter `T` must be a class deriving from ROOT&#39;s `TH1`. It then returns a pointer to the desired object. Managing histograms not on the level of an analysis also enables for requesting histograms from another analysis. In that way one can write a custom analysis for a specific use case but can still ask for e.g. for a histogram from the `BasicMCAnalysis` to derive some additional and more generic information about a simulation run. Hence, never manually delete an object obtained like this.</div><div class="line"><a name="l00138"></a><span class="lineno">  138</span>&#160;</div><div class="line"><a name="l00139"></a><span class="lineno">  139</span>&#160;### Comparing analysis values to reference reference values</div><div class="line"><a name="l00140"></a><span class="lineno">  140</span>&#160;</div><div class="line"><a name="l00141"></a><span class="lineno">  141</span>&#160;For the `BasicMCAnalysis` there is a small test suite to compare the obtained values from a simulation run to reference values contained in a JSON file. So far, that is a prototype only caring about the total number of steps and total number of tracks obtained in the simulation. The `JSON` file looks as follows</div><div class="line"><a name="l00142"></a><span class="lineno">  142</span>&#160;```json</div><div class="line"><a name="l00143"></a><span class="lineno">  143</span>&#160;{</div><div class="line"><a name="l00144"></a><span class="lineno">  144</span>&#160;  &quot;analysisName&quot;: &quot;BasicMCAnalysis&quot;,</div><div class="line"><a name="l00145"></a><span class="lineno">  145</span>&#160;  &quot;nSteps&quot;: [absoluteNumberOfSteps, relativeTolerance],</div><div class="line"><a name="l00146"></a><span class="lineno">  146</span>&#160;  &quot;nTracks&quot;: [absoluteNumberOfTracks, relativeTolerance]</div><div class="line"><a name="l00147"></a><span class="lineno">  147</span>&#160;}</div><div class="line"><a name="l00148"></a><span class="lineno">  148</span>&#160;```</div><div class="line"><a name="l00149"></a><span class="lineno">  149</span>&#160;The test is steered via</div><div class="line"><a name="l00150"></a><span class="lineno">  150</span>&#160;```bash</div><div class="line"><a name="l00151"></a><span class="lineno">  151</span>&#160;runTestBasicMCAnalysis -- &lt;path/to/Analysis.root&gt; &lt;reference.json&gt;</div><div class="line"><a name="l00152"></a><span class="lineno">  152</span>&#160;```</div><div class="line"><a name="l00153"></a><span class="lineno">  153</span>&#160;Note, that the test does not know anything about the settings of the simulation run, i.e. there are no information about the primary generator of the transport engine etc. The user has to make sure to apply this coherently.</div><div class="line"><a name="l00154"></a><span class="lineno">  154</span>&#160;</div><div class="line"><a name="l00155"></a><span class="lineno">  155</span>&#160;### Writing/running a custom analysis</div><div class="line"><a name="l00156"></a><span class="lineno">  156</span>&#160;</div><div class="line"><a name="l00157"></a><span class="lineno">  157</span>&#160;Although providing already a number of different observables, users might want to add custom observables for their analysis. To do so, a directory for custom analyses has to be created where analysis macros can be provided and loaded at run-time. Note, that only the basic analysis is actually contained in the compiled code. One of the main reasons for that is to enable for a coherent comparison between different points in the git history. However, if you feel like there is an important observable missing, feel free to report that.</div><div class="line"><a name="l00158"></a><span class="lineno">  158</span>&#160;</div><div class="line"><a name="l00159"></a><span class="lineno">  159</span>&#160;The logic of adding a custom analysis is very similar to that of `Rivet` and the general workflow should look familiar in any case. Say, your analysis macro directory is `$ANALYSIS_MACROS/` where you have your macro `mySimulationAnalysisc.C` (don&#39;t place any other files there since these cannot be read...). A skeleton looks as follows, also containing more information on how and why things are implemented like they are:</div><div class="line"><a name="l00160"></a><span class="lineno">  160</span>&#160;</div><div class="line"><a name="l00161"></a><span class="lineno">  161</span>&#160;```c++</div><div class="line"><a name="l00162"></a><span class="lineno">  162</span>&#160;// myMCStepAnalysis.C</div><div class="line"><a name="l00163"></a><span class="lineno">  163</span>&#160;//</div><div class="line"><a name="l00164"></a><span class="lineno">  164</span>&#160;// headers you need</div><div class="line"><a name="l00165"></a><span class="lineno">  165</span>&#160;</div><div class="line"><a name="l00166"></a><span class="lineno">  166</span>&#160;/* Your analysis class has to derive from the base o2::mcstepanalysis::MCAnalysis. All</div><div class="line"><a name="l00167"></a><span class="lineno">  167</span>&#160; * methods to be implemented are mentioned below.</div><div class="line"><a name="l00168"></a><span class="lineno">  168</span>&#160; */</div><div class="line"><a name="l00169"></a><span class="lineno">  169</span>&#160;class MyMCStepAnalysis : public MCAnalysis</div><div class="line"><a name="l00170"></a><span class="lineno">  170</span>&#160;{</div><div class="line"><a name="l00171"></a><span class="lineno">  171</span>&#160;  public:</div><div class="line"><a name="l00172"></a><span class="lineno">  172</span>&#160;   /* You don&#39;t need a fancy constructor, that&#39;s it. The base constructor takes care</div><div class="line"><a name="l00173"></a><span class="lineno">  173</span>&#160;    * of registering this analysis to the global o2::MCStepAnalysis::MCAnalysisManager</div><div class="line"><a name="l00174"></a><span class="lineno">  174</span>&#160;    * object. An MCAnalysis object cannot exist without the MCAnalysisManager.</div><div class="line"><a name="l00175"></a><span class="lineno">  175</span>&#160;    */</div><div class="line"><a name="l00176"></a><span class="lineno">  176</span>&#160;    MySimulationAnalysis()</div><div class="line"><a name="l00177"></a><span class="lineno">  177</span>&#160;      : MCAnalysis(&quot;MyMCStepAnalysis&quot;)</div><div class="line"><a name="l00178"></a><span class="lineno">  178</span>&#160;    {}</div><div class="line"><a name="l00179"></a><span class="lineno">  179</span>&#160;</div><div class="line"><a name="l00180"></a><span class="lineno">  180</span>&#160;    /* There are 3 methods covering the analysis: initialize, analyze and finalize.</div><div class="line"><a name="l00181"></a><span class="lineno">  181</span>&#160;     * The first two need to be overriden in any case.</div><div class="line"><a name="l00182"></a><span class="lineno">  182</span>&#160;     * These methods are called by the MCAnalysisManager. Other custom methods</div><div class="line"><a name="l00183"></a><span class="lineno">  183</span>&#160;     * can hence only be used for class-internal purposes only.</div><div class="line"><a name="l00184"></a><span class="lineno">  184</span>&#160;     */</div><div class="line"><a name="l00185"></a><span class="lineno">  185</span>&#160;</div><div class="line"><a name="l00186"></a><span class="lineno">  186</span>&#160;    /* All histograms used in the analysis must be defined here. This is done using</div><div class="line"><a name="l00187"></a><span class="lineno">  187</span>&#160;     * the method MCAnalysis::getHistogram&lt;T&gt;(...) where the template paramter T has to</div><div class="line"><a name="l00188"></a><span class="lineno">  188</span>&#160;     * be a deriving class of ROOT&#39;s TH1. The histogram pointers are the managed</div><div class="line"><a name="l00189"></a><span class="lineno">  189</span>&#160;     * globally for further processing, saving, plotting etc. It is also taken care</div><div class="line"><a name="l00190"></a><span class="lineno">  190</span>&#160;     * of the deletion of the pointers. Do not attempt to delete histograms obtained by</div><div class="line"><a name="l00191"></a><span class="lineno">  191</span>&#160;     * MCAnalysis::getHistogram&lt;T&gt;(...). Histograms are uniquely identified by there</div><div class="line"><a name="l00192"></a><span class="lineno">  192</span>&#160;     * name and an MCAnalysis will stop immediately at the initialisation stage if</div><div class="line"><a name="l00193"></a><span class="lineno">  193</span>&#160;     * two histograms with the same name are detected.</div><div class="line"><a name="l00194"></a><span class="lineno">  194</span>&#160;     */</div><div class="line"><a name="l00195"></a><span class="lineno">  195</span>&#160;    void initialize() override {</div><div class="line"><a name="l00196"></a><span class="lineno">  196</span>&#160;</div><div class="line"><a name="l00197"></a><span class="lineno">  197</span>&#160;     // monitor calls to the magnetic field per volume</div><div class="line"><a name="l00198"></a><span class="lineno">  198</span>&#160;     histMyFirstObservable = getHistogram&lt;TH1D&gt;(&quot;myFirstObservable&quot;, 1, 0., 1.);</div><div class="line"><a name="l00199"></a><span class="lineno">  199</span>&#160;     // monitor the steps in the r-z plane</div><div class="line"><a name="l00200"></a><span class="lineno">  200</span>&#160;     histMySecondObservable = getHistogram&lt;TH2D&gt;(&quot;mySecondObservable&quot;, 1, 0., 1., 2, 0., 2.);</div><div class="line"><a name="l00201"></a><span class="lineno">  201</span>&#160;     // more histograms?! Other things to do?</div><div class="line"><a name="l00202"></a><span class="lineno">  202</span>&#160;</div><div class="line"><a name="l00203"></a><span class="lineno">  203</span>&#160;    }</div><div class="line"><a name="l00204"></a><span class="lineno">  204</span>&#160;</div><div class="line"><a name="l00205"></a><span class="lineno">  205</span>&#160;    /* This method is used to extract the step information in order to fill histograms</div><div class="line"><a name="l00206"></a><span class="lineno">  206</span>&#160;     * accordingly.</div><div class="line"><a name="l00207"></a><span class="lineno">  207</span>&#160;     */</div><div class="line"><a name="l00208"></a><span class="lineno">  208</span>&#160;    void analyze(const std::vector&lt;StepInfo&gt;* const steps,</div><div class="line"><a name="l00209"></a><span class="lineno">  209</span>&#160;                const std::vector&lt;MagCallInfo&gt;* const magCalls) override {</div><div class="line"><a name="l00210"></a><span class="lineno">  210</span>&#160;</div><div class="line"><a name="l00211"></a><span class="lineno">  211</span>&#160;      // loop over mag field calls and match to step ID</div><div class="line"><a name="l00212"></a><span class="lineno">  212</span>&#160;     for(const auto&amp; call : *magCalls) {</div><div class="line"><a name="l00213"></a><span class="lineno">  213</span>&#160;       auto step = steps-&gt;operator[](call.stepid);</div><div class="line"><a name="l00214"></a><span class="lineno">  214</span>&#160;       mAnalysisManager-&gt;getLookupVolName(step.volId, volName);</div><div class="line"><a name="l00215"></a><span class="lineno">  215</span>&#160;       histMyFirstObservable-&gt;Fill(volName.c_str(), 1.);</div><div class="line"><a name="l00216"></a><span class="lineno">  216</span>&#160;     }</div><div class="line"><a name="l00217"></a><span class="lineno">  217</span>&#160;</div><div class="line"><a name="l00218"></a><span class="lineno">  218</span>&#160;      // loop over steps and get z-position and other things as you like</div><div class="line"><a name="l00219"></a><span class="lineno">  219</span>&#160;     for(const auto&amp; step : *steps) {</div><div class="line"><a name="l00220"></a><span class="lineno">  220</span>&#160;       histMySecondObservable-&gt;Fill(step.z, std::sqrt( step.x*step.x + step.y*step.y ));</div><div class="line"><a name="l00221"></a><span class="lineno">  221</span>&#160;       // ...and do more, as you like</div><div class="line"><a name="l00222"></a><span class="lineno">  222</span>&#160;     }</div><div class="line"><a name="l00223"></a><span class="lineno">  223</span>&#160;    }</div><div class="line"><a name="l00224"></a><span class="lineno">  224</span>&#160;</div><div class="line"><a name="l00225"></a><span class="lineno">  225</span>&#160;    /* the finalyze method can be used to do necessary adjustments like scaling or adding</div><div class="line"><a name="l00226"></a><span class="lineno">  226</span>&#160;     * histograms or whatever must be done to them.</div><div class="line"><a name="l00227"></a><span class="lineno">  227</span>&#160;     */</div><div class="line"><a name="l00228"></a><span class="lineno">  228</span>&#160;    void finalize() override {</div><div class="line"><a name="l00229"></a><span class="lineno">  229</span>&#160;     histMyFirstObservable-&gt;Scale( 1. / histMyFirstObservable-&gt;GetEntries() );</div><div class="line"><a name="l00230"></a><span class="lineno">  230</span>&#160;     // ...and more...</div><div class="line"><a name="l00231"></a><span class="lineno">  231</span>&#160;    }</div><div class="line"><a name="l00232"></a><span class="lineno">  232</span>&#160;</div><div class="line"><a name="l00233"></a><span class="lineno">  233</span>&#160;  private:</div><div class="line"><a name="l00234"></a><span class="lineno">  234</span>&#160;   // you might want to provide some useful methods for internal use...</div><div class="line"><a name="l00235"></a><span class="lineno">  235</span>&#160;</div><div class="line"><a name="l00236"></a><span class="lineno">  236</span>&#160;  private:</div><div class="line"><a name="l00237"></a><span class="lineno">  237</span>&#160;   TH1D* histMyFirstObservable;</div><div class="line"><a name="l00238"></a><span class="lineno">  238</span>&#160;   TH2D* histMySecondObservable;</div><div class="line"><a name="l00239"></a><span class="lineno">  239</span>&#160;   // other histogram pointers and/or members for internal usage</div><div class="line"><a name="l00240"></a><span class="lineno">  240</span>&#160; };</div><div class="line"><a name="l00241"></a><span class="lineno">  241</span>&#160;</div><div class="line"><a name="l00242"></a><span class="lineno">  242</span>&#160;/* The hook to bring your analysis into existence so that the MCAnalysisManager</div><div class="line"><a name="l00243"></a><span class="lineno">  243</span>&#160; * knows. Don&#39;t be scared about the way the pointer of the analysis is created. It is all</div><div class="line"><a name="l00244"></a><span class="lineno">  244</span>&#160; * taken care of by the MCAnalysisManager since the base MCAnalysis constructor</div><div class="line"><a name="l00245"></a><span class="lineno">  245</span>&#160; * automatically registeres itself to the MCAnalysisManager. So don&#39;t worry about</div><div class="line"><a name="l00246"></a><span class="lineno">  246</span>&#160; * pointers flying around.</div><div class="line"><a name="l00247"></a><span class="lineno">  247</span>&#160; */</div><div class="line"><a name="l00248"></a><span class="lineno">  248</span>&#160;void declareAnalysis() {</div><div class="line"><a name="l00249"></a><span class="lineno">  249</span>&#160; new MySimulationAnalysis(&quot;mySimulationAnalysis&quot;);</div><div class="line"><a name="l00250"></a><span class="lineno">  250</span>&#160;}</div><div class="line"><a name="l00251"></a><span class="lineno">  251</span>&#160;```</div><div class="line"><a name="l00252"></a><span class="lineno">  252</span>&#160;After having this, you are ready to include this in the analysis run by typing</div><div class="line"><a name="l00253"></a><span class="lineno">  253</span>&#160;```bash</div><div class="line"><a name="l00254"></a><span class="lineno">  254</span>&#160;runMCAnalysis analyze -f &lt;MCStepLoggerOutputFile&gt; -o &lt;parent/output/dir&gt; -l &lt;label&gt; -d $ANALYSIS_MACROS -a mySimulationAnalysis</div><div class="line"><a name="l00255"></a><span class="lineno">  255</span>&#160;```</div><div class="line"><a name="l00256"></a><span class="lineno">  256</span>&#160;where now</div><div class="line"><a name="l00257"></a><span class="lineno">  257</span>&#160;* `-d $ANALYSIS_MACROS` points the executable to the directory of where your macros are located</div><div class="line"><a name="l00258"></a><span class="lineno">  258</span>&#160;* `-a  mySimulationAnalysis` tells which analysis to load. In case you have more analyses in that directory you want to load, just append the names of all analyses you want to run.</div><div class="line"><a name="l00259"></a><span class="lineno">  259</span>&#160;The output of the custom analysis is written to `parent/output/dir/mySimulationAnalysis/` and that&#39;s it.</div></div><!-- fragment --></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="navelem"><a class="el" href="../../d1/dec/Utilities_2MCStepLogger_2README_8md.html">README.md</a></li>
    <li class="footer">Generated on Thu Jun 4 2020 09:30:20 for Project by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="../../doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
